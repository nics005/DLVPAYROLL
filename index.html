<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DLV Electrical Services Co. Payroll System</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom scrollbar for the content area */
        .content-area::-webkit-scrollbar {
            width: 8px;
        }
        .content-area::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .content-area::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .content-area::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Modal backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        /* Modal content */
        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 600px;
            max-height: 90vh; /* Limit height to prevent overflow */
            overflow-y: auto; /* Enable scrolling for modal content */
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Left Navigation Bar -->
    <nav class="w-64 bg-gray-800 text-white p-6 flex flex-col shadow-lg rounded-r-lg">
        <div class="text-2xl font-bold mb-8 text-center">
            DLV Payroll
        </div>
        <ul class="space-y-4">
            <li>
                <button class="nav-button w-full flex items-center px-4 py-2 rounded-lg text-left text-gray-300 hover:bg-gray-700 hover:text-white transition-colors duration-200" data-target="dashboard">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 001 1h3m-6-11v10a1 1 0 001 1h3"></path></svg>
                    Dashboard
                </button>
            </li>
            <li>
                <button class="nav-button admin-feature-only w-full flex items-center px-4 py-2 rounded-lg text-left text-gray-300 hover:bg-gray-700 hover:text-white transition-colors duration-200" data-target="manage-employee">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H2v-2a3 3 0 015.356-1.857M17 20v-2c0-.129-.007-.257-.02-.385m-1.993 0A5.002 5.002 0 0012 18a5.002 5.002 0 00-3.986-1.995M12 12h.01M12 7a2 2 0 110 4 2 2 0 010-4zm0 6a2 2 0 110 4 2 2 0 010-4z"></path></svg>
                    Manage Employee
                </button>
            </li>
            <li>
                <button class="nav-button admin-feature-only w-full flex items-center px-4 py-2 rounded-lg text-left text-gray-300 hover:bg-gray-700 hover:text-white transition-colors duration-200" data-target="site">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                    Site
                </button>
            </li>
            <li>
                <button class="nav-button admin-feature-only w-full flex items-center px-4 py-2 rounded-lg text-left text-gray-300 hover:bg-gray-700 hover:text-white transition-colors duration-200" data-target="process-payroll">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    Process Payroll
                </button>
            </li>
            <!-- New Deductions Navigation Button -->
            <li>
                <button class="nav-button admin-feature-only w-full flex items-center px-4 py-2 rounded-lg text-left text-gray-300 hover:bg-gray-700 hover:text-white transition-colors duration-200" data-target="deductions">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                    Deductions
                </button>
            </li>
            <!-- New Payroll Summary Navigation Button -->
            <li>
                <button class="nav-button admin-feature-only w-full flex items-center px-4 py-2 rounded-lg text-left text-gray-300 hover:bg-gray-700 hover:text-white transition-colors duration-200" data-target="payroll-summary">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 2v-2m9-10H3a2 2 0 00-2 2v12a2 2 0 002 2h18a2 2 0 002-2V3a2 2 0 00-2-2z"></path></svg>
                    Payroll Summary
                </button>
            </li>
        </ul>
        <div class="mt-auto pt-4 border-t border-gray-700">
            <button id="activate-admin-mode-button" class="w-full flex items-center px-4 py-2 rounded-lg text-left bg-blue-600 text-white hover:bg-blue-700 transition-colors duration-200">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path></svg>
                Activate Admin Mode
            </button>
            <button id="deactivate-admin-mode-button" class="admin-feature-only w-full flex items-center px-4 py-2 rounded-lg text-left bg-red-600 text-white hover:bg-red-700 transition-colors duration-200 mt-2">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                Deactivate Admin Mode
            </button>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-1 flex flex-col bg-gray-100 rounded-l-lg overflow-hidden">
        <!-- Header -->
        <header class="bg-white p-4 shadow-md flex items-center justify-between rounded-tl-lg">
            <h1 class="text-2xl font-semibold text-gray-800" id="current-page-title">Dashboard</h1>
            <div class="flex items-center space-x-4">
                <span class="text-gray-600">Welcome, Admin!</span>
                <span id="display-user-id" class="text-gray-500 text-sm font-semibold ml-2"></span>
                <img src="https://placehold.co/40x40/cbd5e1/4a5568?text=AD" alt="Admin Avatar" class="w-10 h-10 rounded-full border-2 border-gray-300">
            </div>
        </header>

        <!-- Content Display Area -->
        <div class="flex-1 p-6 overflow-y-auto content-area">
            <!-- Dashboard Content -->
            <div id="dashboard-content" class="page-content active">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Dashboard Overview</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Card 1: Total Employees -->
                    <div class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-200">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-medium text-gray-700">Total Employees</h3>
                            <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H2v-2a3 3 0 015.356-1.857M17 20v-2c0-.129-.007-.257-.02-.385m-1.993 0A5.002 5.002 0 0012 18a5.002 5.002 0 00-3.986-1.995M12 12h.01M12 7a2 2 0 110 4 2 2 0 010-4zm0 6a2 2 0 110 4 2 2 0 010-4z"></path></svg>
                        </div>
                        <p class="text-4xl font-bold text-gray-900" id="total-employees">0</p>
                        <p class="text-sm text-gray-500 mt-2">Active employees this month</p>
                    </div>

                    <!-- Card 2: Payroll Processed -->
                    <div class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-200">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-medium text-gray-700">Payroll Processed</h3>
                            <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        </div>
                        <p class="text-4xl font-bold text-gray-900" id="payroll-processed">₱ 0</p>
                        <p class="text-sm text-gray-500 mt-2">Total amount disbursed</p>
                    </div>

                    <!-- Card 3: Active Sites -->
                    <div class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-200">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-medium text-gray-700">Active Sites</h3>
                            <svg class="w-8 h-8 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                        </div>
                        <p class="text-4xl font-bold text-gray-900" id="active-sites">0</p>
                        <p class="text-sm text-gray-500 mt-2">Ongoing projects</p>
                    </div>
                </div>

                <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Recent Payroll Activities</h3>
                    <ul class="divide-y divide-gray-200" id="recent-activities-list">
                        </ul>
                </div>
            </div>

            <div id="manage-employee-content" class="page-content hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Manage Employees</h2>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">Employee List</h3>
                        <button id="add-employee-button" class="admin-feature-only bg-blue-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200">
                            Add New Employee
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg">
                            <thead>
                                <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal rounded-t-lg">
                                    <th class="py-3 px-6 text-left rounded-tl-lg">Employee ID</th>
                                    <th class="py-3 px-6 text-left">Name</th>
                                    <th class="py-3 px-6 text-left">Position</th>
                                    <th class="py-3 px-6 text-left">Department/Site</th>
                                    <th class="py-3 px-6 text-left">Contact No.</th>
                                    <th class="py-3 px-6 text-left">Salary Rate</th>
                                    <th class="py-3 px-6 text-left">Status</th>
                                    <th class="py-3 px-6 text-center rounded-tr-lg">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-600 text-sm font-light" id="employee-list-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="site-content" class="page-content hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Manage Sites</h2>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">Project Sites List</h3>
                        <button id="add-site-button" class="admin-feature-only bg-blue-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200">
                            Add New Site
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg">
                            <thead>
                                <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal rounded-t-lg">
                                    <th class="py-3 px-6 text-left rounded-tl-lg">Site ID</th>
                                    <th class="py-3 px-6 text-left">Site Name</th>
                                    <th class="py-3 px-6 text-left">Location</th>
                                    <th class="py-3 px-6 text-center rounded-tr-lg">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-600 text-sm font-light" id="site-list-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Process Payroll Content -->
            <div id="process-payroll-content" class="page-content hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Process Payroll</h2>
                <div id="process-payroll-tables-container" class="space-y-8">
                    <!-- Employee data grouped by department/site will be dynamically loaded here -->
                </div>

                <!-- New: Recent Payroll Records Table -->
                <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Recent Payroll Records</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg border border-gray-200">
                            <thead>
                                <tr class="bg-gray-100 text-gray-600 uppercase text-xs leading-normal">
                                    <th class="py-2 px-4 text-left rounded-tl-lg">Date</th>
                                    <th class="py-2 px-4 text-left">Employee ID</th>
                                    <th class="py-2 px-4 text-left">Name</th>
                                    <th class="py-2 px-4 text-right">Gross Pay</th>
                                    <th class="py-2 px-4 text-center rounded-tr-lg">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-600 text-sm font-light" id="payroll-records-list-body">
                                <!-- Payroll records will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- New Deductions Content -->
            <div id="deductions-content" class="page-content hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Manage Deductions</h2>
                <div id="deductions-tables-container" class="space-y-8">
                    <!-- Employee data grouped by department/site will be dynamically loaded here -->
                </div>

                <!-- New: Recent Deduction Records Table -->
                <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Recent Deduction Records</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg border border-gray-200">
                            <thead>
                                <tr class="bg-gray-100 text-gray-600 uppercase text-xs leading-normal">
                                    <th class="py-2 px-4 text-left rounded-tl-lg">Date</th>
                                    <th class="py-2 px-4 text-left">Employee ID</th>
                                    <th class="py-2 px-4 text-left">Name</th>
                                    <th class="py-2 px-4 text-right">Total Deductions</th>
                                    <th class="py-2 px-4 text-right">Net Pay</th>
                                    <th class="py-2 px-4 text-center rounded-tr-lg">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-600 text-sm font-light" id="deduction-records-list-body">
                                <!-- Deduction records will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Payroll Summary Content -->
            <div id="payroll-summary-content" class="page-content hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Payroll Summary</h2>
                <div class="mb-4">
                    <label for="payroll-summary-department-filter" class="block text-sm font-medium text-gray-700">Filter by Department/Site:</label>
                    <select id="payroll-summary-department-filter" class="mt-1 block w-full md:w-1/3 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                        <option value="">All Departments/Sites</option>
                    </select>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg">
                            <thead>
                                <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal rounded-t-lg">
                                    <th class="py-3 px-6 text-left rounded-tl-lg">Employee ID</th>
                                    <th class="py-3 px-6 text-left">Name</th>
                                    <th class="py-3 px-6 text-left">Department/Site</th> <!-- NEW COLUMN -->
                                    <th class="py-3 px-6 text-left">Total Gross Pay</th>
                                    <th class="py-3 px-6 text-left">Total Deductions</th>
                                    <th class="py-3 px-6 text-left">Total Net Pay</th>
                                    <th class="py-3 px-6 text-center rounded-tr-lg">Payroll Count</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-600 text-sm font-light" id="payroll-summary-list-body">
                                <!-- Payroll summary data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="add-employee-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Add New Employee</h2>
            <form id="add-employee-form" class="space-y-4">
                <div>
                    <label for="employee-id" class="block text-sm font-medium text-gray-700">Employee ID</label>
                    <input type="text" id="employee-id" name="employeeId" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" readonly>
                </div>
                <div>
                    <label for="full-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                    <input type="text" id="full-name" name="fullName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" required>
                </div>
                <div>
                    <label for="position" class="block text-sm font-medium text-gray-700">Position</label>
                    <input type="text" id="position" name="position" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" required>
                </div>
                <div>
                    <label for="address" class="block text-sm font-medium text-gray-700">Address</label>
                    <input type="text" id="address" name="address" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" required>
                </div>
                <div>
                    <label for="contact-no" class="block text-sm font-medium text-gray-700">Contact No.</label>
                    <input type="text" id="contact-no" name="contactNo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" required>
                </div>
                <div>
                    <label for="department-site-dropdown" class="block text-sm font-medium text-gray-700">Department/Site</label>
                    <select id="department-site-dropdown" name="departmentSite" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" required>
                        <option value="">Select Department/Site</option>
                        </select>
                </div>
                <div>
                    <label for="salary-rate" class="block text-sm font-medium text-gray-700">Salary Rate (PHP)</label>
                    <input type="number" id="salary-rate" name="salaryRate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" step="0.01" value="0.00" required>
                </div>
                <div>
                    <label for="sss-contribution" class="block text-sm font-medium text-gray-700">SSS Contribution</label>
                    <input type="number" id="sss-contribution" name="sssContribution" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" step="0.01" value="0.00">
                </div>
                <div>
                    <label for="ph-contribution" class="block text-sm font-medium text-gray-700">PhilHealth Contribution</label>
                    <input type="number" id="ph-contribution" name="phContribution" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" step="0.01" value="0.00">
                </div>
                <div>
                    <label for="pagibig-contribution" class="block text-sm font-medium text-gray-700">Pag-IBIG Contribution</label>
                    <input type="number" id="pagibig-contribution" name="pagibigContribution" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" step="0.01" value="0.00">
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancel-add-employee" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg shadow-md hover:bg-gray-400 transition-colors duration-200">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200">
                        Save Employee
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-employee-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Edit Employee Details</h2>
            <form id="edit-employee-form" class="space-y-4">
                <input type="hidden" id="edit-employee-doc-id" name="docId">
                <div>
                    <label for="edit-employee-id" class="block text-sm font-medium text-gray-700">Employee ID</label>
                    <input type="text" id="edit-employee-id" name="employeeId" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" readonly>
                </div>
                <div>
                    <label for="edit-full-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                    <input type="text" id="edit-full-name" name="fullName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" required>
                </div>
                <div>
                    <label for="edit-position" class="block text-sm font-medium text-gray-700">Position</label>
                    <input type="text" id="edit-position" name="position" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" required>
                </div>
                <div>
                    <label for="edit-address" class="block text-sm font-medium text-gray-700">Address</label>
                    <input type="text" id="edit-address" name="address" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" required>
                </div>
                <div>
                    <label for="edit-contact-no" class="block text-sm font-medium text-gray-700">Contact No.</label>
                    <input type="text" id="edit-contact-no" name="contactNo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" required>
                </div>
                <div>
                    <label for="edit-department-site-dropdown" class="block text-sm font-medium text-gray-700">Department/Site</label>
                    <select id="edit-department-site-dropdown" name="departmentSite" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" required>
                        <option value="">Select Department/Site</option>
                        </select>
                </div>
                <div>
                    <label for="edit-salary-rate" class="block text-sm font-medium text-gray-700">Salary Rate (PHP)</label>
                    <input type="number" id="edit-salary-rate" name="salaryRate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" step="0.01" required>
                </div>
                <div>
                    <label for="edit-sss-contribution" class="block text-sm font-medium text-gray-700">SSS Contribution</label>
                    <input type="number" id="edit-sss-contribution" name="sssContribution" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" step="0.01">
                </div>
                <div>
                    <label for="edit-ph-contribution" class="block text-sm font-medium text-gray-700">PhilHealth Contribution</label>
                    <input type="number" id="edit-ph-contribution" name="phContribution" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" step="0.01">
                </div>
                <div>
                    <label for="edit-pagibig-contribution" class="block text-sm font-medium text-gray-700">Pag-IBIG Contribution</label>
                    <input type="number" id="edit-pagibig-contribution" name="pagibigContribution" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" step="0.01">
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancel-edit-employee" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg shadow-md hover:bg-gray-400 transition-colors duration-200">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200">
                        Update Employee
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-site-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Add New Site</h2>
            <form id="add-site-form" class="space-y-4">
                <div>
                    <label for="site-id" class="block text-sm font-medium text-gray-700">Site ID</label>
                    <input type="text" id="site-id" name="siteId" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" readonly>
                </div>
                <div>
                    <label for="site-name" class="block text-sm font-medium text-gray-700">Site Name</label>
                    <input type="text" id="site-name" name="siteName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" required>
                </div>
                <div>
                    <label for="site-location" class="block text-sm font-medium text-gray-700">Location</label>
                    <input type="text" id="site-location" name="siteLocation" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" required>
                </div>
                <!-- Removed Status field from site modal -->
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancel-add-site" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg shadow-md hover:bg-gray-400 transition-colors duration-200">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200">
                        Save Site
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="admin-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Activate Admin Mode</h2>
            <div class="space-y-4">
                <div>
                    <label for="admin-password-input" class="block text-sm font-medium text-gray-700">Admin Password</label>
                    <input type="password" id="admin-password-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" required>
                    <span id="admin-error-message" class="text-red-500 text-sm mt-1 block"></span>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancel-admin-modal-button" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg shadow-md hover:bg-gray-400 transition-colors duration-200">
                        Cancel
                    </button>
                    <button type="button" id="activate-admin-modal-button" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200">
                        Activate
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirmation-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Confirm Deletion</h2>
            <p class="text-gray-700 mb-6" id="delete-confirmation-message">Are you sure you want to delete this record? This action cannot be undone.</p>
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" id="cancel-delete-button" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg shadow-md hover:bg-gray-400 transition-colors duration-200">
                        Cancel
                    </button>
                <button type="button" id="confirm-delete-button" class="px-4 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition-colors duration-200">
                        Delete
                    </button>
            </div>
        </div>
    </div>

    <!-- New Payroll Input Modal -->
    <div id="payroll-input-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Payroll Input for Employee</h2>
            <div class="mb-4">
                <p class="text-lg font-semibold text-gray-700">Name: <span id="payroll-employee-name" class="font-normal"></span></p>
                <p class="text-lg font-semibold text-gray-700">Employee ID: <span id="payroll-employee-id" class="font-normal"></span></p>
                <!-- Hidden input to store the employee's Firestore document ID -->
                <input type="hidden" id="payroll-employee-doc-id">
                <input type="hidden" id="payroll-employee-salary-rate">
                <!-- NEW: Hidden inputs for government contributions to be used in calculation -->
                <input type="hidden" id="payroll-hidden-sss-contribution" value="0">
                <input type="hidden" id="payroll-hidden-ph-contribution" value="0">
                <input type="hidden" id="payroll-hidden-pagibig-contribution" value="0">
            </div>
            <form id="payroll-input-form" class="space-y-4">
                <div>
                    <label for="working-days" class="block text-sm font-medium text-gray-700">Working Days</label>
                    <input type="number" id="working-days" name="workingDays" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="0" min="0" step="0.5">
                </div>
                <div>
                    <label for="overtime-hrs" class="block text-sm font-medium text-gray-700">Overtime Hours</label>
                    <input type="number" id="overtime-hrs" name="overtimeHrs" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="0" min="0" step="0.5">
                </div>
                <div>
                    <label for="sunday-holiday-duty" class="block text-sm font-medium text-gray-700">Sunday/Holiday Duty (Hours)</label>
                    <input type="number" id="sunday-holiday-duty" name="sundayHolidayDuty" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="0" min="0" step="0.5">
                </div>
                <div>
                    <label for="night-shift-work-days" class="block text-sm font-medium text-gray-700">Night Shift Work Days (8-hour shifts)</label>
                    <input type="number" id="night-shift-work-days" name="nightShiftWorkDays" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="0" min="0" step="0.5">
                </div>
                <div>
                    <label for="night-shift-overtime-hrs" class="block text-sm font-medium text-gray-700">Night Shift Overtime Hours</label>
                    <input type="number" id="night-shift-overtime-hrs" name="nightShiftOvertimeHrs" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="0" min="0" step="0.5">
                </div>

                <!-- Payroll Summary Table -->
                <div class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Payroll Summary</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg border border-gray-200">
                            <thead>
                                <tr class="bg-gray-100 text-gray-600 uppercase text-xs leading-normal">
                                    <th class="py-2 px-4 text-left rounded-tl-lg">Item</th>
                                    <th class="py-2 px-4 text-right rounded-tr-lg">Amount</th>
                                </tr>
                            </thead>
                            <tbody id="payroll-summary-table-body" class="text-gray-700 text-sm font-light">
                                <!-- Dynamic rows will be inserted here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancel-payroll-input" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg shadow-md hover:bg-gray-400 transition-colors duration-200">
                        Close
                    </button>
                    <button type="submit" id="save-payroll-button" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200">
                        Save Payroll
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Deductions Input Modal -->
    <div id="deductions-input-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Other Deductions Input for Employee</h2>
            <div class="mb-4">
                <p class="text-lg font-semibold text-gray-700">Name: <span id="deductions-employee-name" class="font-normal"></span></p>
                <p class="text-lg font-semibold text-gray-700">Employee ID: <span id="deductions-employee-id" class="font-normal"></span></p>
                <input type="hidden" id="deductions-employee-doc-id">
                <input type="hidden" id="deductions-employee-payroll-doc-id">
            </div>
            <form id="deductions-input-form" class="space-y-4">
                <div class="bg-gray-100 p-4 rounded-md">
                    <p class="text-md font-medium text-gray-700">Latest Gross Pay (After Gov. Contributions):</p>
                    <p class="text-2xl font-bold text-gray-900" id="deductions-gross-pay">₱ 0.00</p>
                </div>

                <!-- Other Deductions (editable inputs) -->
                <div class="pt-4 border-t border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Other Deductions</h3>
                </div>
                <div>
                    <label for="govt-loan" class="block text-sm font-medium text-gray-700">Government Loan</label>
                    <input type="number" id="govt-loan" name="govtLoan" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="0" min="0" step="0.01">
                </div>
                <div>
                    <label for="coop-share" class="block text-sm font-medium text-gray-700">Coop Share</label>
                    <input type="number" id="coop-share" name="coopShare" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="0" min="0" step="0.01">
                </div>
                <div>
                    <label for="withholding-tax" class="block text-sm font-medium text-gray-700">With Holding Tax</label>
                    <input type="number" id="withholding-tax" name="withholdingTax" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="0" min="0" step="0.01">
                </div>
                <div>
                    <label for="unpaid-loan" class="block text-sm font-medium text-gray-700">Unpaid Loan</label>
                    <input type="number" id="unpaid-loan" name="unpaidLoan" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="0" min="0" step="0.01">
                </div>
                <div>
                    <label for="coop-2025" class="block text-sm font-medium text-gray-700">Coop 2025</label>
                    <input type="number" id="coop-2025" name="coop2025" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="0" min="0" step="0.01">
                </div>
                <div>
                    <label for="ca-voucher" class="block text-sm font-medium text-gray-700">C/A Voucher</label>
                    <input type="number" id="ca-voucher" name="caVoucher" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="0" min="0" step="0.01">
                </div>
                <div>
                    <label for="daily-vale" class="block text-sm font-medium text-gray-700">Daily Vale</label>
                    <input type="number" id="daily-vale" name="dailyVale" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="0" min="0" step="0.01">
                </div>
                <div>
                    <label for="others-deduction" class="block text-sm font-medium text-gray-700">Others</label>
                    <input type="number" id="others-deduction" name="othersDeduction" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="0" min="0" step="0.01">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-gray-200">
                    <div class="col-span-full text-right pt-2">
                        <p class="text-xl font-bold text-gray-900 mt-2">Total Other Deductions: <span id="calculated-total-deductions">₱ 0.00</span></p>
                        <p class="text-xl font-bold text-gray-900 mt-2">Net Pay: <span id="calculated-net-pay">₱ 0.00</span></p>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancel-deductions-input" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg shadow-md hover:bg-gray-400 transition-colors duration-200">
                        Close
                    </button>
                    <button type="submit" id="save-deductions-button" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200">
                        Save Deductions
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Payroll Modal (Duplicated from payroll-input-modal) -->
    <div id="edit-payroll-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Edit Payroll Record</h2>
            <div class="mb-4">
                <p class="text-lg font-semibold text-gray-700">Name: <span id="edit-payroll-employee-name" class="font-normal"></span></p>
                <p class="text-lg font-semibold text-gray-700">Employee ID: <span id="edit-payroll-employee-id" class="font-normal"></span></p>
                <input type="hidden" id="edit-payroll-doc-id"> <!-- Hidden input for payroll record's doc ID -->
                <input type="hidden" id="edit-payroll-employee-doc-id"> <!-- Hidden input for employee's doc ID -->
                <input type="hidden" id="edit-payroll-employee-salary-rate">
                <input type="hidden" id="edit-payroll-hidden-sss-contribution" value="0">
                <input type="hidden" id="edit-payroll-hidden-ph-contribution" value="0">
                <input type="hidden" id="edit-payroll-hidden-pagibig-contribution" value="0">
            </div>
            <form id="edit-payroll-form" class="space-y-4">
                <div>
                    <label for="edit-working-days" class="block text-sm font-medium text-gray-700">Working Days</label>
                    <input type="number" id="edit-working-days" name="workingDays" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="0" min="0" step="0.5">
                </div>
                <div>
                    <label for="edit-overtime-hrs" class="block text-sm font-medium text-gray-700">Overtime Hours</label>
                    <input type="number" id="edit-overtime-hrs" name="overtimeHrs" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="0" min="0" step="0.5">
                </div>
                <div>
                    <label for="edit-sunday-holiday-duty" class="block text-sm font-medium text-gray-700">Sunday/Holiday Duty (Hours)</label>
                    <input type="number" id="edit-sunday-holiday-duty" name="sundayHolidayDuty" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="0" min="0" step="0.5">
                </div>
                <div>
                    <label for="edit-night-shift-work-days" class="block text-sm font-medium text-gray-700">Night Shift Work Days (8-hour shifts)</label>
                    <input type="number" id="edit-night-shift-work-days" name="nightShiftWorkDays" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="0" min="0" step="0.5">
                </div>
                <div>
                    <label for="edit-night-shift-overtime-hrs" class="block text-sm font-medium text-gray-700">Night Shift Overtime Hours</label>
                    <input type="number" id="edit-night-shift-overtime-hrs" name="nightShiftOvertimeHrs" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="0" min="0" step="0.5">
                </div>

                <!-- Payroll Summary Table -->
                <div class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Payroll Summary</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg border border-gray-200">
                            <thead>
                                <tr class="bg-gray-100 text-gray-600 uppercase text-xs leading-normal">
                                    <th class="py-2 px-4 text-left rounded-tl-lg">Item</th>
                                    <th class="py-2 px-4 text-right rounded-tr-lg">Amount</th>
                                </tr>
                            </thead>
                            <tbody id="edit-payroll-summary-table-body" class="text-gray-700 text-sm font-light">
                                <!-- Dynamic rows will be inserted here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancel-edit-payroll-button" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg shadow-md hover:bg-gray-400 transition-colors duration-200">
                        Close
                    </button>
                    <button type="submit" id="update-payroll-button" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200">
                        Update Payroll
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Deductions Modal (Duplicated from deductions-input-modal) -->
    <div id="edit-deductions-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Edit Other Deductions Record</h2>
            <div class="mb-4">
                <p class="text-lg font-semibold text-gray-700">Name: <span id="edit-deductions-employee-name" class="font-normal"></span></p>
                <p class="text-lg font-semibold text-gray-700">Employee ID: <span id="edit-deductions-employee-id" class="font-normal"></span></p>
                <input type="hidden" id="edit-deductions-doc-id"> <!-- Hidden input for deduction record's doc ID -->
                <input type="hidden" id="edit-deductions-employee-doc-id">
                <input type="hidden" id="edit-deductions-employee-payroll-doc-id">
            </div>
            <form id="edit-deductions-form" class="space-y-4">
                <div class="bg-gray-100 p-4 rounded-md">
                    <p class="text-md font-medium text-gray-700">Latest Gross Pay (After Gov. Contributions):</p>
                    <p class="text-2xl font-bold text-gray-900" id="edit-deductions-gross-pay">₱ 0.00</p>
                </div>

                <!-- Other Deductions (editable inputs) -->
                <div class="pt-4 border-t border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Other Deductions</h3>
                </div>
                <div>
                    <label for="edit-govt-loan" class="block text-sm font-medium text-gray-700">Government Loan</label>
                    <input type="number" id="edit-govt-loan" name="govtLoan" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="0" min="0" step="0.01">
                </div>
                <div>
                    <label for="edit-coop-share" class="block text-sm font-medium text-gray-700">Coop Share</label>
                    <input type="number" id="edit-coop-share" name="coopShare" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="0" min="0" step="0.01">
                </div>
                <div>
                    <label for="edit-withholding-tax" class="block text-sm font-medium text-gray-700">With Holding Tax</label>
                    <input type="number" id="edit-withholding-tax" name="withholdingTax" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="0" min="0" step="0.01">
                </div>
                <div>
                    <label for="edit-unpaid-loan" class="block text-sm font-medium text-gray-700">Unpaid Loan</label>
                    <input type="number" id="edit-unpaid-loan" name="unpaidLoan" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="0" min="0" step="0.01">
                </div>
                <div>
                    <label for="edit-coop-2025" class="block text-sm font-medium text-gray-700">Coop 2025</label>
                    <input type="number" id="edit-coop-2025" name="coop2025" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="0" min="0" step="0.01">
                </div>
                <div>
                    <label for="edit-ca-voucher" class="block text-sm font-medium text-gray-700">C/A Voucher</label>
                    <input type="number" id="edit-ca-voucher" name="caVoucher" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="0" min="0" step="0.01">
                </div>
                <div>
                    <label for="edit-daily-vale" class="block text-sm font-medium text-gray-700">Daily Vale</label>
                    <input type="number" id="edit-daily-vale" name="dailyVale" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="0" min="0" step="0.01">
                </div>
                <div>
                    <label for="edit-others-deduction" class="block text-sm font-medium text-gray-700">Others</label>
                    <input type="number" id="edit-others-deduction" name="othersDeduction" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="0" min="0" step="0.01">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-gray-200">
                    <div class="col-span-full text-right pt-2">
                        <p class="text-xl font-bold text-gray-900 mt-2">Total Other Deductions: <span id="edit-calculated-total-deductions">₱ 0.00</span></p>
                        <p class="text-xl font-bold text-gray-900 mt-2">Net Pay: <span id="edit-calculated-net-pay">₱ 0.00</span></p>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancel-edit-deductions-button" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg shadow-md hover:bg-gray-400 transition-colors duration-200">
                        Close
                    </button>
                    <button type="submit" id="update-deductions-button" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200">
                        Update Deductions
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, updateDoc, deleteDoc, getDoc, getDocs, orderBy, limit, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration (provided by the user)
        const firebaseConfig = {
            apiKey: "AIzaSyAYpApEwrgAsso-dJ-uTAX3AI4yRZBn9JU",
            authDomain: "payroll-aef73.firebaseapp.com",
            projectId: "payroll-aef73",
            storageBucket: "payroll-aef73.firebaseapp.com",
            messagingSenderId: "717714854870",
            appId: "1:717714854870:web:b1e7eb0dc82cd61dbc8a77",
            measurementId: "G-F31PSMN7RD"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId = null;
        // __app_id and __initial_auth_token are provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

        // Admin Mode variables
        let isAdminMode = false;
        // **WARNING:** Hardcoding passwords in client-side code is highly insecure.
        // For a real application, implement proper Firebase Authentication for admin users
        // and check custom claims or roles for authorization.
        const ADMIN_PASSWORD = "dlvadmin"; 

        // --- Global element references (declared as let, assigned in DOMContentLoaded) ---
        let totalEmployeesCard;
        let payrollProcessedCard;
        let activeSitesCard;
        let recentActivitiesList;
        let employeeListBody; // For Manage Employee tab
        let processPayrollTablesContainer; // Container for grouped tables
        let deductionsTablesContainer; // New container for deductions
        let departmentSiteDropdown;
        let editDepartmentSiteDropdown; // For Edit Employee Modal
        let siteListBody;
        let displayUserIdSpan;
        let payrollSummaryListBody; // New: For Payroll Summary table body
        let payrollSummaryDepartmentFilter; // New: Payroll Summary filter dropdown
        let payrollRecordsListBody; // New: For displaying payroll records
        let deductionRecordsListBody; // New: For displaying deduction records

        // Admin mode related elements
        let adminFeatureElements; 
        let activateAdminModeButton;
        let deactivateAdminModeButton; 
        let adminModal;
        let adminPasswordInput;
        let activateAdminModalButton;
        let cancelAdminModalButton;
        let adminErrorMessage;

        // Global references for navigation and page content
        let navButtons;
        let pageContents;
        let currentPageTitle;

        // Employee Modals
        let addEmployeeButton;
        let addEmployeeModal;
        let cancelAddEmployee;
        let addEmployeeForm;
        let employeeIdInput;

        let editEmployeeModal;
        let cancelEditEmployee;
        let editEmployeeForm;
        let editEmployeeDocIdInput;
        let editEmployeeIdInput; 
        let editFullNameInput;
        let editPositionInput;
        let editAddressInput;
        let editContactNoInput;
        let editSalaryRateInput;
        let editSssContributionInput;
        let editPhilhealthContributionInput;
        let editPagibigContributionInput;


        // Site Modals
        let addSiteButton;
        let addSiteModal;
        let cancelAddSite;
        let addSiteForm; 
        let siteIdInput;

        // Delete Confirmation Modal
        let deleteConfirmationModal;
        let cancelDeleteButton;
        let confirmDeleteButton;
        let deleteConfirmationMessage; // New element for dynamic message
        let itemToDeleteDocId = null; // To store the ID of the item to be deleted
        let itemToDeleteCollection = null; // To store the collection of the item to be deleted

        // Payroll Input Modal elements
        let payrollInputModal;
        let cancelPayrollInputButton;
        let payrollEmployeeNameSpan;
        let payrollEmployeeIdSpan;
        let payrollEmployeeDocIdInput; // New hidden input for doc ID
        let payrollEmployeeSalaryRateInput;
        let workingDaysInput;
        let overtimeHrsInput;
        let sundayHolidayDutyInput;
        let nightShiftWorkDaysInput;
        let nightShiftOvertimeHrsInput;
        
        // New elements for SSS, PhilHealth, Pag-IBIG contributions in payroll modal (now hidden inputs)
        let payrollHiddenSssContributionInput;
        let payrollHiddenPhContributionInput;
        let payrollHiddenPagibigContributionInput;

        // New: Payroll Summary Table Body within the modal
        let payrollSummaryTableBody;
        let payrollInputForm;


        // Deductions Input Modal elements (now for Other Deductions only)
        let deductionsInputModal;
        let cancelDeductionsInputButton;
        let deductionsEmployeeNameSpan;
        let deductionsEmployeeIdSpan;
        let deductionsEmployeeDocIdInput;
        let deductionsEmployeePayrollDocIdInput;
        let deductionsGrossPaySpan; // This will be Gross Pay (After Gov. Contributions)

        let govtLoanInput;
        let coopShareInput;
        let withholdingTaxInput;
        let unpaidLoanInput;
        let coop2025Input;
        let caVoucherInput;
        let dailyValeInput;
        let othersDeductionInput;
        let calculatedTotalDeductionsSpan; // This will now be Total Other Deductions
        let calculatedNetPaySpan;
        let deductionsInputForm;

        // New: Edit Payroll Modal elements
        let editPayrollModal;
        let cancelEditPayrollButton;
        let editPayrollForm;
        let editPayrollDocIdInput;
        let editPayrollEmployeeNameSpan;
        let editPayrollEmployeeIdSpan;
        let editPayrollEmployeeDocIdInput;
        let editPayrollEmployeeSalaryRateInput;
        let editWorkingDaysInput;
        let editOvertimeHrsInput;
        let editSundayHolidayDutyInput;
        let editNightShiftWorkDaysInput;
        let editNightShiftOvertimeHrsInput;
        let editPayrollHiddenSssContributionInput;
        let editPayrollHiddenPhContributionInput;
        let editPayrollHiddenPagibigContributionInput;
        let editPayrollSummaryTableBody;

        // New: Edit Deductions Modal elements
        let editDeductionsModal;
        let cancelEditDeductionsButton;
        let editDeductionsForm;
        let editDeductionsDocIdInput;
        let editDeductionsEmployeeNameSpan;
        let editDeductionsEmployeeIdSpan;
        let editDeductionsEmployeeDocIdInput;
        let editDeductionsEmployeePayrollDocIdInput;
        let editDeductionsGrossPaySpan;
        let editGovtLoanInput;
        let editCoopShareInput;
        let editWithholdingTaxInput;
        let editUnpaidLoanInput;
        let editCoop2025Input;
        let editCaVoucherInput;
        let editDailyValeInput;
        let editOthersDeductionInput;
        let editCalculatedTotalDeductionsSpan;
        let editCalculatedNetPaySpan;


        /**
         * Populates the Department/Site dropdowns with data from Firestore sites.
         * Clears existing options before populating.
         */
        const populateDepartmentSiteDropdown = async () => {
            const dropdowns = [departmentSiteDropdown, editDepartmentSiteDropdown];
            
            // Clear existing options in both dropdowns
            dropdowns.forEach(dropdown => {
                if (dropdown) {
                    dropdown.innerHTML = '<option value="">Select Department/Site</option>'; 
                }
            });

            try {
                if (!userId) {
                    console.warn("User not authenticated yet. Cannot fetch sites for dropdown.");
                    return;
                }
                const q = query(collection(db, `/artifacts/${appId}/public/data/sites`));
                const querySnapshot = await getDocs(q); // Use getDocs for a one-time fetch
                querySnapshot.forEach((doc) => {
                    const site = doc.data();
                    const option = document.createElement('option');
                    option.value = site.siteName;
                    option.textContent = `Site: ${site.siteName} (${site.siteLocation})`;
                    
                    dropdowns.forEach(dropdown => {
                        if (dropdown) {
                            dropdown.appendChild(option.cloneNode(true)); // Clone to add to both
                        }
                    });
                });
            } catch (e) {
                console.error("Error populating department/site dropdown: ", e);
            }
        };

        /**
         * Populates the Payroll Summary Department/Site filter dropdown with unique department/site names.
         */
        const populatePayrollSummaryDepartmentFilter = async () => {
            if (!payrollSummaryDepartmentFilter) return;

            payrollSummaryDepartmentFilter.innerHTML = '<option value="">All Departments/Sites</option>'; // Always start with "All" option

            try {
                if (!userId) {
                    console.warn("User not authenticated yet. Cannot fetch employees for filter dropdown.");
                    return;
                }
                const q = query(collection(db, `/artifacts/${appId}/public/data/employees`));
                const querySnapshot = await getDocs(q);
                const uniqueDepartments = new Set();
                querySnapshot.forEach((doc) => {
                    const employee = doc.data();
                    if (employee.departmentSite) {
                        uniqueDepartments.add(employee.departmentSite);
                    }
                });

                Array.from(uniqueDepartments).sort().forEach(department => {
                    const option = document.createElement('option');
                    option.value = department;
                    option.textContent = department;
                    payrollSummaryDepartmentFilter.appendChild(option);
                });
            } catch (e) {
                console.error("Error populating payroll summary department filter: ", e);
            }
        };


        /**
         * Fetches and displays employee data in the Manage Employee, Process Payroll,
         * and Deductions tables. Groups employees by department/site for payroll/deductions.
         * Updates dashboard employee and payroll counts.
         */
        const fetchEmployees = () => {
            if (!userId) {
                console.warn("User not authenticated. Cannot fetch employees.");
                return;
            }
            const q = query(collection(db, `/artifacts/${appId}/public/data/employees`), orderBy("departmentSite"));
            onSnapshot(q, (querySnapshot) => {
                if (employeeListBody) employeeListBody.innerHTML = ''; // Clear current list for Manage Employee
                if (processPayrollTablesContainer) processPayrollTablesContainer.innerHTML = ''; // Clear current list for Process Payroll
                if (deductionsTablesContainer) deductionsTablesContainer.innerHTML = ''; // Clear current list for Deductions

                let totalEmployees = 0;
                let totalPayroll = 0;
                const groupedEmployees = {}; // Object to group employees by department/site

                querySnapshot.forEach((doc) => {
                    totalEmployees++;
                    const employee = doc.data();
                    const employeeId = doc.id; 
                    totalPayroll += parseFloat(employee.salaryRate || 0);

                    // Add employee to the groupedEmployees object
                    const departmentSite = employee.departmentSite || 'Unassigned';
                    if (!groupedEmployees[departmentSite]) {
                        groupedEmployees[departmentSite] = [];
                    }
                    groupedEmployees[departmentSite].push({ ...employee, docId: doc.id });

                    // Row for Manage Employee table
                    if (employeeListBody) {
                        const manageRow = employeeListBody.insertRow();
                        manageRow.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100');
                        manageRow.innerHTML = `
                            <td class="py-3 px-6 text-left whitespace-nowrap">${employee.employeeId || employeeId}</td>
                            <td class="py-3 px-6 text-left">${employee.fullName || ''}</td>
                            <td class="py-3 px-6 text-left">${employee.position || ''}</td>
                            <td class="py-3 px-6 text-left">${employee.departmentSite || ''}</td>
                            <td class="py-3 px-6 text-left">${employee.contactNo || ''}</td>
                            <td class="py-3 px-6 text-left">₱ ${parseFloat(employee.salaryRate || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                            <td class="py-3 px-6 text-left"><span class="bg-green-200 text-green-600 py-1 px-3 rounded-full text-xs">Active</span></td>
                            <td class="py-3 px-6 text-center">
                                <div class="flex item-center justify-center space-x-2">
                                    <button class="w-4 mr-2 transform hover:text-purple-500 hover:scale-110 edit-employee-btn" data-id="${doc.id}">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                    </button>
                                    <button class="w-4 mr-2 transform hover:text-red-500 hover:scale-110 delete-item-btn" data-id="${doc.id}" data-collection="employees">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                </div>
                            </td>
                        `;
                    }
                });
                if (totalEmployeesCard) totalEmployeesCard.textContent = totalEmployees;
                if (payrollProcessedCard) payrollProcessedCard.textContent = `₱ ${totalPayroll.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

                // Dynamically create tables for Process Payroll based on grouped employees
                for (const siteName in groupedEmployees) {
                    // Process Payroll Table (Employee Selection)
                    if (processPayrollTablesContainer) {
                        let payrollSiteSection = document.createElement('div');
                        payrollSiteSection.classList.add('bg-white', 'p-6', 'rounded-lg', 'shadow-md', 'mb-6');
                        payrollSiteSection.innerHTML += `
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Department/Site: ${siteName}</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white rounded-lg border border-gray-200">
                                    <thead>
                                        <tr class="bg-gray-100 text-gray-600 uppercase text-xs leading-normal">
                                            <th class="py-2 px-4 text-left rounded-tl-lg">Employee ID</th>
                                            <th class="py-2 px-4 text-left">Name</th>
                                            <th class="py-2 px-4 text-left">Position</th>
                                            <th class="py-2 px-4 text-left">Status</th>
                                            <th class="py-2 px-4 text-center rounded-tr-lg">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-gray-600 text-sm font-light" id="process-payroll-table-${siteName.replace(/\s/g, '-')}-body">
                                    </tbody>
                                </table>
                            </div>
                        `;
                        processPayrollTablesContainer.appendChild(payrollSiteSection);
                    }

                    let currentPayrollSiteTbody = document.getElementById(`process-payroll-table-${siteName.replace(/\s/g, '-')}-body`);

                    // Deductions Table (Employee Selection)
                    if (deductionsTablesContainer) {
                        let deductionsSiteSection = document.createElement('div');
                        deductionsSiteSection.classList.add('bg-white', 'p-6', 'rounded-lg', 'shadow-md', 'mb-6');
                        deductionsSiteSection.innerHTML += `
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Department/Site: ${siteName}</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white rounded-lg border border-gray-200">
                                    <thead>
                                        <tr class="bg-gray-100 text-gray-600 uppercase text-xs leading-normal">
                                            <th class="py-2 px-4 text-left rounded-tl-lg">Employee ID</th>
                                            <th class="py-2 px-4 text-left">Name</th>
                                            <th class="py-2 px-4 text-left">Position</th>
                                            <th class="py-2 px-4 text-left">Status</th>
                                            <th class="py-2 px-4 text-center rounded-tr-lg">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-gray-600 text-sm font-light" id="deductions-table-${siteName.replace(/\s/g, '-')}-body">
                                    </tbody>
                                </table>
                            </div>
                        `;
                        deductionsTablesContainer.appendChild(deductionsSiteSection);
                    }

                    let currentDeductionsSiteTbody = document.getElementById(`deductions-table-${siteName.replace(/\s/g, '-')}-body`);

                    groupedEmployees[siteName].forEach(employee => {
                        // Populate Process Payroll Table (Employee Selection)
                        if (currentPayrollSiteTbody) {
                            const payrollRow = currentPayrollSiteTbody.insertRow();
                            payrollRow.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100');
                            payrollRow.innerHTML = `
                                <td class="py-3 px-6 text-left whitespace-nowrap">
                                    <button class="text-blue-600 hover:underline open-payroll-input-btn" data-id="${employee.docId}">
                                        ${employee.employeeId || employee.docId}
                                    </button>
                                </td>
                                <td class="py-3 px-6 text-left">${employee.fullName || ''}</td>
                                <td class="py-3 px-6 text-left">${employee.position || ''}</td>
                                <td class="py-3 px-6 text-left"><span class="bg-green-200 text-green-600 py-1 px-3 rounded-full text-xs">${employee.status || ''}</span></td>
                                <td class="py-3 px-6 text-center">
                                    <div class="flex item-center justify-center space-x-2">
                                        <button class="w-4 mr-2 transform hover:text-purple-500 hover:scale-110 edit-employee-btn-payroll" data-id="${employee.docId}">
                                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                        </button>
                                        <button class="w-4 mr-2 transform hover:text-red-500 hover:scale-110 delete-item-btn" data-id="${employee.docId}" data-collection="employees">
                                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                        </button>
                                    </div>
                                </td>
                            `;
                        }

                        // Populate Deductions Table (Employee Selection)
                        if (currentDeductionsSiteTbody) {
                            const deductionsRow = currentDeductionsSiteTbody.insertRow();
                            deductionsRow.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100');
                            deductionsRow.innerHTML = `
                                <td class="py-3 px-6 text-left whitespace-nowrap">
                                    <button class="text-blue-600 hover:underline open-deductions-input-btn" data-id="${employee.docId}">
                                        ${employee.employeeId || employee.docId}
                                    </button>
                                </td>
                                <td class="py-3 px-6 text-left">${employee.fullName || ''}</td>
                                <td class="py-3 px-6 text-left">${employee.position || ''}</td>
                                <td class="py-3 px-6 text-left"><span class="bg-green-200 text-green-600 py-1 px-3 rounded-full text-xs">${employee.status || ''}</span></td>
                                <td class="py-3 px-6 text-center">
                                    <div class="flex item-center justify-center space-x-2">
                                        <button class="w-4 mr-2 transform hover:text-purple-500 hover:scale-110 edit-employee-btn-deductions" data-id="${employee.docId}">
                                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                        </button>
                                        <button class="w-4 mr-2 transform hover:text-red-500 hover:scale-110 delete-item-btn" data-id="${employee.docId}" data-collection="employees">
                                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                        </button>
                                    </div>
                                </td>
                            `;
                        }
                    });
                }

                // Attach event listeners after all content is loaded
                attachActionListeners(); // Renamed from attachEmployeeActionListeners
            }, (error) => {
                console.error("Error fetching employees: ", error);
            });
        };

        /**
         * Fetches and displays all payroll records in the dedicated table.
         */
        const fetchPayrollRecords = () => {
            if (!userId) {
                console.warn("User not authenticated. Cannot fetch payroll records.");
                return;
            }
            if (payrollRecordsListBody) payrollRecordsListBody.innerHTML = `<tr><td colspan="5" class="py-3 px-6 text-center text-gray-500">Loading payroll records...</td></tr>`;

            const q = query(collection(db, `/artifacts/${appId}/public/data/payroll_records`), orderBy("payrollDate", "desc"));
            onSnapshot(q, async (querySnapshot) => {
                if (payrollRecordsListBody) payrollRecordsListBody.innerHTML = ''; // Clear current list
                if (querySnapshot.empty) {
                    if (payrollRecordsListBody) payrollRecordsListBody.innerHTML = `<tr><td colspan="5" class="py-3 px-6 text-center text-gray-500">No payroll records found.</td></tr>`;
                    return;
                }

                const employeePromises = [];
                const payrollRecords = [];

                querySnapshot.forEach(doc => {
                    const record = doc.data();
                    payrollRecords.push({ ...record, docId: doc.id });
                    // Fetch employee data to get full name and employee ID
                    employeePromises.push(getDoc(doc(db, `/artifacts/${appId}/public/data/employees`, record.employeeDocId)));
                });

                const employeeSnaps = await Promise.all(employeePromises);
                const employeeMap = {};
                employeeSnaps.forEach(snap => {
                    if (snap.exists()) {
                        employeeMap[snap.id] = snap.data();
                    }
                });

                payrollRecords.forEach(record => {
                    const employeeData = employeeMap[record.employeeDocId] || {};
                    const newRow = payrollRecordsListBody.insertRow();
                    newRow.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100');
                    newRow.innerHTML = `
                        <td class="py-3 px-6 text-left whitespace-nowrap">${record.payrollDate ? new Date(record.payrollDate.seconds * 1000).toLocaleDateString() : 'N/A'}</td>
                        <td class="py-3 px-6 text-left">${employeeData.employeeId || record.employeeId || 'N/A'}</td>
                        <td class="py-3 px-6 text-left">${employeeData.fullName || record.employeeName || 'N/A'}</td>
                        <td class="py-3 px-6 text-right">₱ ${parseFloat(record.grossPay || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="py-3 px-6 text-center">
                            <div class="flex item-center justify-center space-x-2">
                                <button class="w-4 mr-2 transform hover:text-purple-500 hover:scale-110 edit-payroll-record-btn" data-id="${record.docId}">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                </button>
                                <button class="w-4 mr-2 transform hover:text-red-500 hover:scale-110 delete-item-btn" data-id="${record.docId}" data-collection="payroll_records">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        </td>
                    `;
                });
                attachActionListeners();
            }, (error) => {
                console.error("Error fetching payroll records: ", error);
                if (payrollRecordsListBody) payrollRecordsListBody.innerHTML = `<tr><td colspan="5" class="py-3 px-6 text-center text-red-500">Error loading payroll records: ${error.message}</td></tr>`;
            });
        };

        /**
         * Fetches and displays all deduction records in the dedicated table.
         */
        const fetchDeductionRecords = () => {
            if (!userId) {
                console.warn("User not authenticated. Cannot fetch deduction records.");
                return;
            }
            if (deductionRecordsListBody) deductionRecordsListBody.innerHTML = `<tr><td colspan="6" class="py-3 px-6 text-center text-gray-500">Loading deduction records...</td></tr>`;

            const q = query(collection(db, `/artifacts/${appId}/public/data/deduction_records`), orderBy("deductionDate", "desc"));
            onSnapshot(q, async (querySnapshot) => {
                if (deductionRecordsListBody) deductionRecordsListBody.innerHTML = ''; // Clear current list
                if (querySnapshot.empty) {
                    if (deductionRecordsListBody) deductionRecordsListBody.innerHTML = `<tr><td colspan="6" class="py-3 px-6 text-center text-gray-500">No deduction records found.</td></tr>`;
                    return;
                }

                const employeePromises = [];
                const deductionRecords = [];

                querySnapshot.forEach(doc => {
                    const record = doc.data();
                    deductionRecords.push({ ...record, docId: doc.id });
                    // Fetch employee data to get full name and employee ID
                    employeePromises.push(getDoc(doc(db, `/artifacts/${appId}/public/data/employees`, record.employeeDocId)));
                });

                const employeeSnaps = await Promise.all(employeePromises);
                const employeeMap = {};
                employeeSnaps.forEach(snap => {
                    if (snap.exists()) {
                        employeeMap[snap.id] = snap.data();
                    }
                    // If employee data is not found, the map will simply not have an entry for that ID.
                    // The display logic below will handle 'N/A' for missing employee data.
                });

                deductionRecords.forEach(record => {
                    const employeeData = employeeMap[record.employeeDocId] || {};
                    const newRow = deductionRecordsListBody.insertRow();
                    newRow.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100');
                    newRow.innerHTML = `
                        <td class="py-3 px-6 text-left whitespace-nowrap">${record.deductionDate ? new Date(record.deductionDate.seconds * 1000).toLocaleDateString() : 'N/A'}</td>
                        <td class="py-3 px-6 text-left">${employeeData.employeeId || record.employeeId || 'N/A'}</td>
                        <td class="py-3 px-6 text-left">${employeeData.fullName || record.employeeName || 'N/A'}</td>
                        <td class="py-3 px-6 text-right">₱ ${parseFloat(record.totalDeductions || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="py-3 px-6 text-right">₱ ${parseFloat(record.netPay || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td class="py-3 px-6 text-center">
                            <div class="flex item-center justify-center space-x-2">
                                <button class="w-4 mr-2 transform hover:text-purple-500 hover:scale-110 edit-deduction-record-btn" data-id="${record.docId}">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                </button>
                                <button class="w-4 mr-2 transform hover:text-red-500 hover:scale-110 delete-item-btn" data-id="${record.docId}" data-collection="deduction_records">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        </td>
                    `;
                });
                attachActionListeners();
            }, (error) => {
                console.error("Error fetching deduction records: ", error);
                if (deductionRecordsListBody) deductionRecordsListBody.innerHTML = `<tr><td colspan="6" class="py-3 px-6 text-center text-red-500">Error loading deduction records: ${error.message}</td></tr>`;
            });
        };


        /**
         * Attaches event listeners to dynamically created edit/delete buttons
         * for employees, payroll records, and deduction records across different tabs.
         */
        const attachActionListeners = () => {
            // For Manage Employee tab
            document.querySelectorAll('#employee-list-body .edit-employee-btn').forEach(button => {
                button.onclick = (e) => openEditEmployeeModal(e.currentTarget.dataset.id);
            });
            document.querySelectorAll('#employee-list-body .delete-item-btn').forEach(button => {
                button.onclick = (e) => openDeleteConfirmationModal(e.currentTarget.dataset.id, e.currentTarget.dataset.collection);
            });

            // For Process Payroll tab (buttons inside dynamically generated employee tables)
            document.querySelectorAll('#process-payroll-tables-container .edit-employee-btn-payroll').forEach(button => {
                button.onclick = (e) => openEditEmployeeModal(e.currentTarget.dataset.id);
            });
            document.querySelectorAll('#process-payroll-tables-container .delete-item-btn').forEach(button => {
                button.onclick = (e) => openDeleteConfirmationModal(e.currentTarget.dataset.id, e.currentTarget.dataset.collection);
            });
            document.querySelectorAll('.open-payroll-input-btn').forEach(button => {
                button.onclick = (e) => openPayrollInputModal(e.currentTarget.dataset.id);
            });

            // New: For Payroll Records List
            document.querySelectorAll('#payroll-records-list-body .edit-payroll-record-btn').forEach(button => {
                button.onclick = (e) => openEditPayrollModal(e.currentTarget.dataset.id);
            });
            document.querySelectorAll('#payroll-records-list-body .delete-item-btn').forEach(button => {
                button.onclick = (e) => openDeleteConfirmationModal(e.currentTarget.dataset.id, e.currentTarget.dataset.collection);
            });


            // For Deductions tab (buttons inside dynamically generated employee tables)
            document.querySelectorAll('#deductions-tables-container .edit-employee-btn-deductions').forEach(button => {
                button.onclick = (e) => openEditEmployeeModal(e.currentTarget.dataset.id);
            });
            document.querySelectorAll('#deductions-tables-container .delete-item-btn').forEach(button => {
                button.onclick = (e) => openDeleteConfirmationModal(e.currentTarget.dataset.id, e.currentTarget.dataset.collection);
            });
            document.querySelectorAll('.open-deductions-input-btn').forEach(button => {
                button.onclick = (e) => openDeductionsModal(e.currentTarget.dataset.id);
            });

            // New: For Deduction Records List
            document.querySelectorAll('#deduction-records-list-body .edit-deduction-record-btn').forEach(button => {
                button.onclick = (e) => openEditDeductionsModal(e.currentTarget.dataset.id);
            });
            document.querySelectorAll('#deduction-records-list-body .delete-item-btn').forEach(button => {
                button.onclick = (e) => openDeleteConfirmationModal(e.currentTarget.dataset.id, e.currentTarget.dataset.collection);
            });

            // For Site tab
            document.querySelectorAll('#site-list-body .edit-site-btn').forEach(button => {
                button.onclick = (e) => openEditSiteModal(e.currentTarget.dataset.id);
            });
            document.querySelectorAll('#site-list-body .delete-item-btn').forEach(button => {
                button.onclick = (e) => openDeleteConfirmationModal(e.currentTarget.dataset.id, e.currentTarget.dataset.collection);
            });
        };


        /**
         * Fetches and displays site data in the Manage Sites table.
         * Updates the dashboard active sites count.
         */
        const fetchSites = () => {
            if (!userId) {
                console.warn("User not authenticated. Cannot fetch sites.");
                return;
            }
            const q = query(collection(db, `/artifacts/${appId}/public/data/sites`));
            onSnapshot(q, (querySnapshot) => {
                if (siteListBody) siteListBody.innerHTML = ''; // Clear current list
                let activeSitesCount = 0;
                querySnapshot.forEach((doc) => {
                    const site = doc.data();
                    // Removed status check for active sites as status field is removed from site
                    // if (site.siteStatus === 'Ongoing') {
                    //     activeSitesCount++;
                    // }
                    if (siteListBody) {
                        const newRow = siteListBody.insertRow();
                        newRow.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100');

                        // Removed statusColorClass logic
                        newRow.innerHTML = `
                            <td class="py-3 px-6 text-left whitespace-nowrap">${site.siteId || doc.id}</td>
                            <td class="py-3 px-6 text-left">${site.siteName || ''}</td>
                            <td class="py-3 px-6 text-left">${site.siteLocation || ''}</td>
                            <td class="py-3 px-6 text-center">
                                <div class="flex item-center justify-center space-x-2">
                                    <button class="w-4 mr-2 transform hover:text-purple-500 hover:scale-110 edit-site-btn" data-id="${doc.id}">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                    </button>
                                    <button class="w-4 mr-2 transform hover:text-red-500 hover:scale-110 delete-item-btn" data-id="${doc.id}" data-collection="sites">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                </div>
                            </td>
                        `;
                    }
                });
                // Since status is removed, we can't count "active" sites directly from siteStatus.
                // For now, setting to total sites. You might need to define "active" differently.
                if (activeSitesCard) activeSitesCard.textContent = querySnapshot.size; 
                populateDepartmentSiteDropdown(); // Re-populate dropdown after sites are fetched
                attachActionListeners();
            }, (error) => {
                console.error("Error fetching sites: ", error);
            });
        };

        /**
         * Updates the dashboard cards with current employee and site counts.
         */
        const updateDashboardCounts = async () => {
            if (!userId) {
                console.warn("User not authenticated. Cannot update dashboard counts.");
                return;
            }
            try {
                // Employees
                const employeesQuery = query(collection(db, `/artifacts/${appId}/public/data/employees`));
                const employeeSnapshot = await getDocs(employeesQuery);
                let totalEmployees = employeeSnapshot.size;
                let totalPayroll = 0;
                employeeSnapshot.forEach(doc => {
                    const employee = doc.data();
                    totalPayroll += parseFloat(employee.salaryRate || 0);
                });
                if (totalEmployeesCard) totalEmployeesCard.textContent = totalEmployees;
                if (payrollProcessedCard) payrollProcessedCard.textContent = `₱ ${totalPayroll.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

                // Sites
                const sitesQuery = query(collection(db, `/artifacts/${appId}/public/data/sites`));
                const siteSnapshot = await getDocs(sitesQuery);
                // Adjusted active sites count since siteStatus is removed
                if (activeSitesCard) activeSitesCard.textContent = siteSnapshot.size; 

                // Recent Activities (placeholder for now, you'd populate this with actual activity data)
                if (recentActivitiesList) {
                    recentActivitiesList.innerHTML = `
                        <li class="py-3 flex justify-between items-center">
                            <div>
                                <p class="font-medium text-gray-900">No recent activities.</p>
                            </div>
                        </li>
                    `;
                }

            } catch (error) {
                console.error("Error updating dashboard counts:", error);
            }
        };

        /**
         * Fetches and displays a summary of payroll and deduction records per employee.
         * @param {string} departmentSiteFilter - Optional. The department/site name to filter by.
         * If empty or null, all employees are included.
         */
        const fetchPayrollSummary = async (departmentSiteFilter = '') => {
            if (!userId) {
                console.warn("User not authenticated. Cannot fetch payroll summary.");
                if (payrollSummaryListBody) payrollSummaryListBody.innerHTML = `<tr><td colspan="7" class="py-3 px-6 text-center text-gray-500">Please activate admin mode to view payroll summary.</td></tr>`;
                return;
            }

            if (!isAdminMode) {
                if (payrollSummaryListBody) payrollSummaryListBody.innerHTML = `<tr><td colspan="7" class="py-3 px-6 text-center text-gray-500">Please activate admin mode to view payroll summary.</td></tr>`;
                return;
            }


            if (payrollSummaryListBody) payrollSummaryListBody.innerHTML = `<tr><td colspan="7" class="py-3 px-6 text-center text-gray-500">Loading payroll summary...</td></tr>`;

            try {
                // 1. Fetch employees, optionally filtered by department/site
                let employeesQuery;
                if (departmentSiteFilter) {
                    employeesQuery = query(
                        collection(db, `/artifacts/${appId}/public/data/employees`),
                        where("departmentSite", "==", departmentSiteFilter)
                    );
                } else {
                    employeesQuery = query(collection(db, `/artifacts/${appId}/public/data/employees`));
                }
                
                const employeesSnapshot = await getDocs(employeesQuery);
                const employeesMap = {};
                employeesSnapshot.forEach(doc => {
                    employeesMap[doc.id] = doc.data();
                });

                // 2. Fetch all payroll records
                const payrollQuery = query(collection(db, `/artifacts/${appId}/public/data/payroll_records`));
                const payrollSnapshot = await getDocs(payrollQuery);

                // 3. Fetch all deduction records
                const deductionQuery = query(collection(db, `/artifacts/${appId}/public/data/deduction_records`));
                const deductionSnapshot = await getDocs(deductionQuery);

                const employeeSummary = {};

                // Aggregate payroll data, only for filtered employees
                payrollSnapshot.forEach(doc => {
                    const record = doc.data();
                    const employeeDocId = record.employeeDocId;
                    const employeeData = employeesMap[employeeDocId]; // Get employee details

                    // Only include if employeeData exists (meaning it passed the department filter)
                    if (employeeData) { 
                        if (!employeeSummary[employeeDocId]) {
                            employeeSummary[employeeDocId] = {
                                employeeId: record.employeeId,
                                employeeName: employeeData.fullName, // Use full name from employee data
                                departmentSite: employeeData.departmentSite || 'N/A', // Get department/site
                                totalGrossPay: 0,
                                totalDeductions: 0,
                                totalNetPay: 0, 
                                payrollCount: 0,
                            };
                        }
                        employeeSummary[employeeDocId].totalGrossPay += record.grossPay || 0; // This grossPay now includes gov deductions
                        employeeSummary[employeeDocId].payrollCount++;
                    }
                });

                // Aggregate deduction data, only for filtered employees
                deductionSnapshot.forEach(doc => {
                    const record = doc.data();
                    const employeeDocId = record.employeeDocId;

                    // Only include if employeeSummary already contains this employee (meaning it passed the department filter)
                    if (employeeSummary[employeeDocId]) {
                        // totalDeductions in deduction_records now only includes "other" deductions
                        employeeSummary[employeeDocId].totalDeductions += record.totalDeductions || 0; 
                    }
                });

                // Calculate total net pay for each employee and convert to array
                const summaryArray = [];
                for (const empDocId in employeeSummary) {
                    const summary = employeeSummary[empDocId];
                    summary.totalNetPay = summary.totalGrossPay - summary.totalDeductions;
                    summaryArray.push(summary);
                }

                // Sort the summary array by departmentSite
                summaryArray.sort((a, b) => {
                    const siteA = a.departmentSite.toUpperCase(); // ignore case
                    const siteB = b.departmentSite.toUpperCase(); // ignore case
                    if (siteA < siteB) {
                        return -1;
                    }
                    if (siteA > siteB) {
                        return 1;
                    }
                    // If department/site is the same, sort by employee name
                    const nameA = a.employeeName.toUpperCase();
                    const nameB = b.employeeName.toUpperCase();
                    if (nameA < nameB) {
                        return -1;
                    }
                    if (nameA > nameB) {
                        return 1;
                    }
                    return 0; // names must be equal
                });


                // Clear and populate the table
                if (payrollSummaryListBody) payrollSummaryListBody.innerHTML = '';
                if (summaryArray.length === 0) {
                    if (payrollSummaryListBody) payrollSummaryListBody.innerHTML = `<tr><td colspan="7" class="py-3 px-6 text-center text-gray-500">No payroll summary data available for this selection.</td></tr>`;
                } else {
                    summaryArray.forEach(summary => {
                        if (payrollSummaryListBody) {
                            const newRow = payrollSummaryListBody.insertRow();
                            newRow.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100');
                            newRow.innerHTML = `
                                <td class="py-3 px-6 text-left whitespace-nowrap">${summary.employeeId || 'N/A'}</td>
                                <td class="py-3 px-6 text-left">${summary.employeeName || ''}</td>
                                <td class="py-3 px-6 text-left">${summary.departmentSite || 'N/A'}</td> <!-- NEW CELL -->
                                <td class="py-3 px-6 text-left">₱ ${summary.totalGrossPay.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                <td class="py-3 px-6 text-left">₱ ${summary.totalDeductions.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                <td class="py-3 px-6 text-left">₱ ${summary.totalNetPay.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                <td class="py-3 px-6 text-center">${summary.payrollCount}</td>
                            `;
                        }
                    });
                }

            } catch (e) {
                console.error("Error fetching payroll summary: ", e);
                if (payrollSummaryListBody) payrollSummaryListBody.innerHTML = `<tr><td colspan="7" class="py-3 px-6 text-center text-red-500">Error loading summary: ${e.message}</td></tr>`;
            }
        };

        /**
         * Shows the selected content tab and updates the navigation button's active state.
         * Also triggers data fetching for relevant tabs.
         * @param {string} targetId - The ID of the content section to display.
         */
        const showContent = (targetId) => {
            if (pageContents) {
                pageContents.forEach(content => {
                    content.classList.add('hidden');
                    content.classList.remove('active');
                });
            }


            const targetContent = document.getElementById(targetId + '-content');
            if (targetContent) {
                targetContent.classList.remove('hidden');
                targetContent.classList.add('active');
            }

            if (currentPageTitle && navButtons) {
                const buttonText = document.querySelector(`.nav-button[data-target="${targetId}"]`).textContent.trim();
                currentPageTitle.textContent = buttonText;

                navButtons.forEach(button => {
                    if (button.dataset.target === targetId) {
                        button.classList.add('bg-gray-700', 'text-white');
                        button.classList.remove('text-gray-300', 'hover:bg-gray-700');
                    } else {
                        button.classList.remove('bg-gray-700', 'text-white');
                        button.classList.add('text-gray-300', 'hover:bg-gray-700');
                    }
                });
            }

            // Re-fetch data when switching to relevant tabs
            if (targetId === 'manage-employee') {
                fetchEmployees(); // Will populate employee list
                populateDepartmentSiteDropdown();
            } else if (targetId === 'process-payroll') {
                fetchEmployees(); // Will populate employee selection for payroll
                fetchPayrollRecords(); // NEW: Fetch and display all payroll records
            } else if (targetId === 'deductions') {
                fetchEmployees(); // Will populate employee selection for deductions
                fetchDeductionRecords(); // NEW: Fetch and display all deduction records
            } else if (targetId === 'site') {
                fetchSites();
            } else if (targetId === 'dashboard') {
                updateDashboardCounts();
            } else if (targetId === 'payroll-summary') {
                populatePayrollSummaryDepartmentFilter(); // Populate filter dropdown first
                fetchPayrollSummary(); // Call the new function to load summary (initially all)
            }
        };


        // Authenticate user with Firebase
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                console.log("Authenticated with Firebase UID:", userId);
            } else {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        userId = auth.currentUser.uid;
                        console.log("Signed in with custom token. User ID:", userId);
                    } else {
                        // If no initialAuthToken, try anonymous sign-in
                        await signInAnonymously(auth);
                        userId = auth.currentUser.uid;
                        console.log("Signed in anonymously (no custom token). User ID:", userId);
                    }
                } catch (error) {
                    console.error("Authentication failed, attempting fallback to anonymous:", error);
                    try {
                        await signInAnonymously(auth);
                        userId = auth.currentUser.uid;
                        console.log("Signed in anonymously after initial auth failure. User ID:", userId);
                    } catch (anonError) {
                        console.error("Anonymous sign-in also failed:", anonError);
                        // Fallback to random UUID if all Firebase auth fails
                        userId = crypto.randomUUID();
                        console.error("No Firebase user ID obtained, using a temporary UUID:", userId);
                    }
                }
            }

            // After all authentication attempts, ensure userId is set and then fetch data
            if (userId) {
                console.log("Final User ID for data operations:", userId);
                if (displayUserIdSpan) displayUserIdSpan.textContent = `User ID: ${userId}`; // Display the user ID
                fetchEmployees();
                fetchSites();
                updateDashboardCounts();
            } else {
                console.error("Failed to obtain a user ID after all sign-in attempts. Data persistence will not work.");
            }
        });


        /**
         * Updates the visibility of admin-only UI elements based on `isAdminMode` status.
         */
        const updateAdminUI = () => {
            if (adminFeatureElements) {
                adminFeatureElements.forEach(el => {
                    if (isAdminMode) {
                        el.classList.remove('hidden');
                    } else {
                        el.classList.add('hidden');
                    }
                });
            }


            if (activateAdminModeButton) {
                if (isAdminMode) {
                    activateAdminModeButton.classList.add('hidden'); // Hide activate button once activated
                } else {
                    activateAdminModeButton.classList.remove('hidden');
                }
            }
            if (deactivateAdminModeButton) { // Control visibility of deactivate button
                if (isAdminMode) {
                    deactivateAdminModeButton.classList.remove('hidden');
                } else {
                    deactivateAdminModeButton.classList.add('hidden');
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            // --- Assign all global element references here after DOM is loaded ---
            totalEmployeesCard = document.getElementById('total-employees');
            payrollProcessedCard = document.getElementById('payroll-processed');
            activeSitesCard = document.getElementById('active-sites');
            recentActivitiesList = document.getElementById('recent-activities-list');
            employeeListBody = document.getElementById('employee-list-body');
            processPayrollTablesContainer = document.getElementById('process-payroll-tables-container');
            deductionsTablesContainer = document.getElementById('deductions-tables-container');
            departmentSiteDropdown = document.getElementById('department-site-dropdown');
            editDepartmentSiteDropdown = document.getElementById('edit-department-site-dropdown');
            siteListBody = document.getElementById('site-list-body');
            displayUserIdSpan = document.getElementById('display-user-id');
            payrollSummaryListBody = document.getElementById('payroll-summary-list-body');
            payrollSummaryDepartmentFilter = document.getElementById('payroll-summary-department-filter');
            payrollRecordsListBody = document.getElementById('payroll-records-list-body'); // New
            deductionRecordsListBody = document.getElementById('deduction-records-list-body'); // New

            adminFeatureElements = document.querySelectorAll('.admin-feature-only');
            activateAdminModeButton = document.getElementById('activate-admin-mode-button');
            deactivateAdminModeButton = document.getElementById('deactivate-admin-mode-button');
            adminModal = document.getElementById('admin-modal');
            adminPasswordInput = document.getElementById('admin-password-input');
            activateAdminModalButton = document.getElementById('activate-admin-modal-button');
            cancelAdminModalButton = document.getElementById('cancel-admin-modal-button');
            adminErrorMessage = document.getElementById('admin-error-message');

            navButtons = document.querySelectorAll('.nav-button');
            pageContents = document.querySelectorAll('.page-content');
            currentPageTitle = document.getElementById('current-page-title');

            addEmployeeButton = document.getElementById('add-employee-button');
            addEmployeeModal = document.getElementById('add-employee-modal');
            cancelAddEmployee = document.getElementById('cancel-add-employee');
            addEmployeeForm = document.getElementById('add-employee-form');
            employeeIdInput = document.getElementById('employee-id');

            editEmployeeModal = document.getElementById('edit-employee-modal');
            cancelEditEmployee = document.getElementById('cancel-edit-employee');
            editEmployeeForm = document.getElementById('edit-employee-form');
            editEmployeeDocIdInput = document.getElementById('edit-employee-doc-id');
            editEmployeeIdInput = document.getElementById('edit-employee-id');
            editFullNameInput = document.getElementById('edit-full-name');
            editPositionInput = document.getElementById('edit-position');
            editAddressInput = document.getElementById('edit-address');
            editContactNoInput = document.getElementById('edit-contact-no');
            editSalaryRateInput = document.getElementById('edit-salary-rate');
            editSssContributionInput = document.getElementById('edit-sss-contribution');
            editPhilhealthContributionInput = document.getElementById('edit-ph-contribution');
            editPagibigContributionInput = document.getElementById('edit-pagibig-contribution');

            addSiteButton = document.getElementById('add-site-button');
            addSiteModal = document.getElementById('add-site-modal');
            cancelAddSite = document.getElementById('cancel-add-site');
            addSiteForm = document.getElementById('add-site-form');
            siteIdInput = document.getElementById('site-id');

            deleteConfirmationModal = document.getElementById('delete-confirmation-modal');
            cancelDeleteButton = document.getElementById('cancel-delete-button');
            confirmDeleteButton = document.getElementById('confirm-delete-button');
            deleteConfirmationMessage = document.getElementById('delete-confirmation-message'); // New

            payrollInputModal = document.getElementById('payroll-input-modal');
            cancelPayrollInputButton = document.getElementById('cancel-payroll-input');
            payrollEmployeeNameSpan = document.getElementById('payroll-employee-name');
            payrollEmployeeIdSpan = document.getElementById('payroll-employee-id');
            payrollEmployeeDocIdInput = document.getElementById('payroll-employee-doc-id');
            payrollEmployeeSalaryRateInput = document.getElementById('payroll-employee-salary-rate');
            workingDaysInput = document.getElementById('working-days');
            overtimeHrsInput = document.getElementById('overtime-hrs');
            sundayHolidayDutyInput = document.getElementById('sunday-holiday-duty');
            nightShiftWorkDaysInput = document.getElementById('night-shift-work-days');
            nightShiftOvertimeHrsInput = document.getElementById('night-shift-overtime-hrs');
            payrollHiddenSssContributionInput = document.getElementById('payroll-hidden-sss-contribution');
            payrollHiddenPhContributionInput = document.getElementById('payroll-hidden-ph-contribution');
            payrollHiddenPagibigContributionInput = document.getElementById('payroll-hidden-pagibig-contribution');
            payrollSummaryTableBody = document.getElementById('payroll-summary-table-body');
            payrollInputForm = document.getElementById('payroll-input-form'); 

            deductionsInputModal = document.getElementById('deductions-input-modal');
            cancelDeductionsInputButton = document.getElementById('cancel-deductions-input');
            deductionsEmployeeNameSpan = document.getElementById('deductions-employee-name');
            deductionsEmployeeIdSpan = document.getElementById('deductions-employee-id');
            deductionsEmployeeDocIdInput = document.getElementById('deductions-employee-doc-id');
            deductionsEmployeePayrollDocIdInput = document.getElementById('deductions-employee-payroll-doc-id');
            deductionsGrossPaySpan = document.getElementById('deductions-gross-pay');
            govtLoanInput = document.getElementById('govt-loan');
            coopShareInput = document.getElementById('coop-share');
            withholdingTaxInput = document.getElementById('withholding-tax');
            unpaidLoanInput = document.getElementById('unpaid-loan');
            coop2025Input = document.getElementById('coop-2025');
            caVoucherInput = document.getElementById('ca-voucher');
            dailyValeInput = document.getElementById('daily-vale');
            othersDeductionInput = document.getElementById('others-deduction');
            calculatedTotalDeductionsSpan = document.getElementById('calculated-total-deductions');
            calculatedNetPaySpan = document.getElementById('calculated-net-pay');
            deductionsInputForm = document.getElementById('deductions-input-form');

            // New: Edit Payroll Modal elements
            editPayrollModal = document.getElementById('edit-payroll-modal');
            cancelEditPayrollButton = document.getElementById('cancel-edit-payroll-button');
            editPayrollForm = document.getElementById('edit-payroll-form');
            editPayrollDocIdInput = document.getElementById('edit-payroll-doc-id');
            editPayrollEmployeeNameSpan = document.getElementById('edit-payroll-employee-name');
            editPayrollEmployeeIdSpan = document.getElementById('edit-payroll-employee-id');
            editPayrollEmployeeDocIdInput = document.getElementById('edit-payroll-employee-doc-id');
            editPayrollEmployeeSalaryRateInput = document.getElementById('edit-payroll-employee-salary-rate');
            editWorkingDaysInput = document.getElementById('edit-working-days');
            editOvertimeHrsInput = document.getElementById('edit-overtime-hrs');
            editSundayHolidayDutyInput = document.getElementById('edit-sunday-holiday-duty');
            editNightShiftWorkDaysInput = document.getElementById('edit-night-shift-work-days');
            editNightShiftOvertimeHrsInput = document.getElementById('edit-night-shift-overtime-hrs');
            editPayrollHiddenSssContributionInput = document.getElementById('edit-payroll-hidden-sss-contribution');
            editPayrollHiddenPhContributionInput = document.getElementById('edit-payroll-hidden-ph-contribution');
            editPayrollHiddenPagibigContributionInput = document.getElementById('edit-payroll-hidden-pagibig-contribution');
            editPayrollSummaryTableBody = document.getElementById('edit-payroll-summary-table-body');

            // New: Edit Deductions Modal elements
            editDeductionsModal = document.getElementById('edit-deductions-modal');
            cancelEditDeductionsButton = document.getElementById('cancel-edit-deductions-button');
            editDeductionsForm = document.getElementById('edit-deductions-form');
            editDeductionsDocIdInput = document.getElementById('edit-deductions-doc-id');
            editDeductionsEmployeeNameSpan = document.getElementById('edit-deductions-employee-name');
            editDeductionsEmployeeIdSpan = document.getElementById('edit-deductions-employee-id');
            editDeductionsEmployeeDocIdInput = document.getElementById('edit-deductions-employee-doc-id');
            editDeductionsEmployeePayrollDocIdInput = document.getElementById('edit-deductions-employee-payroll-doc-id');
            editDeductionsGrossPaySpan = document.getElementById('edit-deductions-gross-pay');
            editGovtLoanInput = document.getElementById('edit-govt-loan');
            editCoopShareInput = document.getElementById('edit-coop-share');
            editWithholdingTaxInput = document.getElementById('edit-withholding-tax');
            editUnpaidLoanInput = document.getElementById('edit-unpaid-loan');
            editCoop2025Input = document.getElementById('edit-coop-2025');
            editCaVoucherInput = document.getElementById('edit-ca-voucher');
            editDailyValeInput = document.getElementById('edit-daily-vale');
            editOthersDeductionInput = document.getElementById('edit-others-deduction');
            editCalculatedTotalDeductionsSpan = document.getElementById('edit-calculated-total-deductions');
            editCalculatedNetPaySpan = document.getElementById('edit-calculated-net-pay');


            // Check if admin mode was previously activated in this session
            isAdminMode = sessionStorage.getItem('isAdminMode') === 'true';

            // Set initial UI state based on admin mode
            updateAdminUI();
            
            // Always show dashboard on initial load (or if admin mode isn't active)
            showContent('dashboard'); 


            /**
             * Generates a unique employee ID in the format DLV-XXXXX.
             * @returns {string} The generated employee ID.
             */
            const generateEmployeeId = () => {
                const randomNumbers = Math.floor(10000 + Math.random() * 90000); // 5 random digits
                return `DLV-${randomNumbers}`;
            };

            /**
             * Generates a unique site ID in the format DLV-SITE-XXXXX.
             * @returns {string} The generated site ID.
             */
            const generateSiteId = () => {
                const randomNumbers = Math.floor(10000 + Math.random() * 90000); // 5 random digits
                return `DLV-SITE-${randomNumbers}`;
            };

            // Event listener for "Add New Employee" button
            if (addEmployeeButton) { // Ensure button exists before adding listener
                addEmployeeButton.addEventListener('click', () => {
                    if (employeeIdInput) employeeIdInput.value = generateEmployeeId(); // Generate and set ID
                    populateDepartmentSiteDropdown(); // Populate dropdown before showing modal
                    if (addEmployeeModal) addEmployeeModal.classList.remove('hidden');
                });
            }

            // Event listener for "Cancel" button in the add employee modal
            if (cancelAddEmployee) {
                cancelAddEmployee.addEventListener('click', () => {
                    if (addEmployeeModal) addEmployeeModal.classList.add('hidden');
                    if (addEmployeeForm) addEmployeeForm.reset(); // Clear the form
                });
            }

            // Event listener for add employee form submission
            if (addEmployeeForm) {
                addEmployeeForm.addEventListener('submit', async (event) => {
                    event.preventDefault(); // Prevent default form submission

                    if (!userId) {
                        console.error("User not authenticated. Cannot save employee.");
                        return;
                    }

                    const formData = new FormData(addEmployeeForm);
                    const employeeData = {
                        employeeId: formData.get('employeeId'),
                        fullName: formData.get('fullName'),
                        position: formData.get('position'),
                        address: formData.get('address'),
                        contactNo: formData.get('contactNo'),
                        departmentSite: formData.get('departmentSite'),
                        salaryRate: parseFloat(formData.get('salaryRate')),
                        sssContribution: parseFloat(formData.get('sssContribution')),
                        phContribution: parseFloat(formData.get('phContribution')),
                        pagibigContribution: parseFloat(formData.get('pagibigContribution')),
                        status: 'Active', // Default status
                        createdAt: new Date()
                    };

                    try {
                        await addDoc(collection(db, `/artifacts/${appId}/public/data/employees`), employeeData);
                        console.log("Employee added successfully!");
                        if (addEmployeeModal) addEmployeeModal.classList.add('hidden'); // Hide modal after submission
                        if (addEmployeeForm) addEmployeeForm.reset(); // Clear the form
                    } catch (e) {
                        console.error("Error adding employee: ", e);
                    }
                });
            }

            // Event listener for "Cancel" button in the edit employee modal
            if (cancelEditEmployee) {
                cancelEditEmployee.addEventListener('click', () => {
                    if (editEmployeeModal) editEmployeeModal.classList.add('hidden');
                    if (editEmployeeForm) editEmployeeForm.reset();
                });
            }

            // Event listener for edit employee form submission
            if (editEmployeeForm) {
                editEmployeeForm.addEventListener('submit', async (event) => {
                    event.preventDefault();

                    if (!userId) {
                        console.error("User not authenticated. Cannot update employee.");
                        return;
                    }

                    const docId = editEmployeeDocIdInput.value;
                    const employeeRef = doc(db, `/artifacts/${appId}/public/data/employees`, docId);

                    const formData = new FormData(editEmployeeForm);
                    const updatedData = {
                        fullName: formData.get('fullName'),
                        position: formData.get('position'),
                        address: formData.get('address'),
                        contactNo: formData.get('contactNo'),
                        departmentSite: formData.get('departmentSite'),
                        salaryRate: parseFloat(formData.get('salaryRate')),
                        sssContribution: parseFloat(formData.get('sssContribution')),
                        phContribution: parseFloat(formData.get('phContribution')),
                        pagibigContribution: parseFloat(formData.get('pagibigContribution')),
                    };

                    try {
                        await updateDoc(employeeRef, updatedData);
                        console.log("Employee updated successfully!");
                        if (editEmployeeModal) editEmployeeModal.classList.add('hidden');
                        if (editEmployeeForm) editEmployeeForm.reset();
                    }
                    catch (e) {
                        console.error("Error updating employee: ", e);
                    }
                });
            }

            /**
             * Opens the Edit Employee Modal and populates it with the selected employee's data.
             * @param {string} docId - The Firestore document ID of the employee to edit.
             */
            window.openEditEmployeeModal = async (docId) => {
                if (!userId) {
                    console.warn("User not authenticated. Cannot edit employee.");
                    return;
                }
                try {
                    const employeeRef = doc(db, `/artifacts/${appId}/public/data/employees`, docId);
                    const employeeSnap = await getDoc(employeeRef);

                    if (employeeSnap.exists()) {
                        const employeeData = employeeSnap.data();
                        if (editEmployeeDocIdInput) editEmployeeDocIdInput.value = docId;
                        if (editEmployeeIdInput) editEmployeeIdInput.value = employeeData.employeeId || docId;
                        if (editFullNameInput) editFullNameInput.value = employeeData.fullName || '';
                        if (editPositionInput) editPositionInput.value = employeeData.position || '';
                        if (editAddressInput) editAddressInput.value = employeeData.address || '';
                        if (editContactNoInput) editContactNoInput.value = employeeData.contactNo || '';
                        if (editSalaryRateInput) editSalaryRateInput.value = parseFloat(employeeData.salaryRate || 0).toFixed(2);
                        if (editSssContributionInput) editSssContributionInput.value = parseFloat(employeeData.sssContribution || 0).toFixed(2);
                        if (editPhilhealthContributionInput) editPhilhealthContributionInput.value = parseFloat(employeeData.phContribution || 0).toFixed(2);
                        if (editPagibigContributionInput) editPagibigContributionInput.value = parseFloat(employeeData.pagibigContribution || 0).toFixed(2);
                        
                        // Populate and select the correct option in the department/site dropdown
                        await populateDepartmentSiteDropdown(); // Ensure dropdown is populated first
                        if (editDepartmentSiteDropdown) {
                            editDepartmentSiteDropdown.value = employeeData.departmentSite || '';
                        }

                        if (editEmployeeModal) editEmployeeModal.classList.remove('hidden');
                    } else {
                        console.error("No such employee document!");
                    }
                } catch (e) {
                    console.error("Error fetching employee for edit: ", e);
                }
            };

            /**
             * Opens the Edit Site Modal and populates it with the selected site's data.
             * @param {string} docId - The Firestore document ID of the site to edit.
             */
            window.openEditSiteModal = async (docId) => {
                if (!userId) {
                    console.warn("User not authenticated. Cannot edit site.");
                    return;
                }
                try {
                    const siteRef = doc(db, `/artifacts/${appId}/public/data/sites`, docId);
                    const siteSnap = await getDoc(siteRef);

                    if (siteSnap.exists()) {
                        const siteData = siteSnap.data();
                        document.getElementById('edit-site-doc-id').value = docId;
                        document.getElementById('edit-site-id').value = siteData.siteId || docId;
                        document.getElementById('edit-site-name').value = siteData.siteName || '';
                        document.getElementById('edit-site-location').value = siteData.siteLocation || '';
                        // Removed siteStatus from here as it's no longer in the site schema
                        document.getElementById('edit-site-modal').classList.remove('hidden');
                    } else {
                        console.error("No such site document!");
                    }
                } catch (e) {
                    console.error("Error fetching site for edit: ", e);
                }
            };

            // Event listener for edit site form submission
            document.getElementById('edit-site-form').addEventListener('submit', async (event) => {
                event.preventDefault();
                if (!userId) {
                    console.error("User not authenticated. Cannot update site.");
                    return;
                }

                const docId = document.getElementById('edit-site-doc-id').value;
                const siteRef = doc(db, `/artifacts/${appId}/public/data/sites`, docId);

                const formData = new FormData(document.getElementById('edit-site-form'));
                const updatedData = {
                    siteName: formData.get('siteName'),
                    siteLocation: formData.get('siteLocation'),
                    // Removed siteStatus from here as it's no longer in the site schema
                };

                try {
                    await updateDoc(siteRef, updatedData);
                    console.log("Site updated successfully!");
                    document.getElementById('edit-site-modal').classList.add('hidden');
                    document.getElementById('edit-site-form').reset();
                } catch (e) {
                    console.error("Error updating site: ", e);
                }
            });

            // Event listener for "Cancel" button in the edit site modal
            document.getElementById('cancel-edit-site').addEventListener('click', () => {
                document.getElementById('edit-site-modal').classList.add('hidden');
                document.getElementById('edit-site-form').reset();
            });

            /**
             * Opens the Delete Confirmation Modal for a given item.
             * @param {string} docId - The Firestore document ID of the item to delete.
             * @param {string} collectionName - The name of the collection the item belongs to.
             */
            window.openDeleteConfirmationModal = (docId, collectionName) => {
                itemToDeleteDocId = docId; // Store the ID
                itemToDeleteCollection = collectionName; // Store the collection name
                if (deleteConfirmationMessage) {
                    deleteConfirmationMessage.textContent = `Are you sure you want to delete this ${collectionName.replace(/_/g, ' ').slice(0, -1)} record? This action cannot be undone.`;
                }
                if (deleteConfirmationModal) deleteConfirmationModal.classList.remove('hidden');
            };

            // Event listener for "Cancel" button in the delete confirmation modal
            if (cancelDeleteButton) {
                    cancelDeleteButton.addEventListener('click', () => {
                    if (deleteConfirmationModal) deleteConfirmationModal.classList.add('hidden');
                    itemToDeleteDocId = null; // Clear the stored ID
                    itemToDeleteCollection = null; // Clear the stored collection
                });
            }

            // Event listener for "Confirm Delete" button in the delete confirmation modal
            if (confirmDeleteButton) {
                confirmDeleteButton.addEventListener('click', async () => {
                    if (!userId) {
                        console.error("User not authenticated. Cannot delete item.");
                        return;
                    }
                    if (itemToDeleteDocId && itemToDeleteCollection) {
                        try {
                            await deleteDoc(doc(db, `/artifacts/${appId}/public/data/${itemToDeleteCollection}`, itemToDeleteDocId));
                            console.log(`${itemToDeleteCollection} record deleted successfully!`);
                            if (deleteConfirmationModal) deleteConfirmationModal.classList.add('hidden');
                            itemToDeleteDocId = null; // Clear the stored ID
                            itemToDeleteCollection = null; // Clear the stored collection
                        } catch (e) {
                            console.error(`Error deleting ${itemToDeleteCollection} record: `, e);
                        }
                    }
                });
            }


            // Event listener for "Add New Site" button
            if (addSiteButton) { // Ensure button exists before adding listener
                addSiteButton.addEventListener('click', () => {
                    if (siteIdInput) siteIdInput.value = generateSiteId(); // Generate and set ID
                    if (addSiteModal) addSiteModal.classList.remove('hidden');
                });
            }

            // Event listener for "Cancel" button in the site modal
            if (cancelAddSite) {
                cancelAddSite.addEventListener('click', () => {
                    if (addSiteModal) addSiteModal.classList.add('hidden');
                    if (addSiteForm) addSiteForm.reset(); // Clear the form
                });
            }

            // Event listener for site form submission
            if (addSiteForm) {
                addSiteForm.addEventListener('submit', async (event) => {
                    event.preventDefault(); // Prevent default form submission

                    if (!userId) {
                        console.error("User not authenticated. Cannot save site.");
                        return;
                    }

                    const formData = new FormData(addSiteForm);
                    const siteData = {
                        siteId: formData.get('siteId'),
                        siteName: formData.get('siteName'),
                        siteLocation: formData.get('siteLocation'),
                        // Removed siteStatus from siteData
                        createdAt: new Date()
                    };

                    try {
                        // Sites are public data, so they are stored in a public collection
                        await addDoc(collection(db, `/artifacts/${appId}/public/data/sites`), siteData);
                        console.log("Site added successfully!");
                        if (addSiteModal) addSiteModal.classList.add('hidden'); // Hide modal after submission
                        if (addSiteForm) addSiteForm.reset(); // Clear the form
                    } catch (e) {
                        console.error("Error adding site: ", e);
                    }
                });
            }

            /**
             * Helper function to format currency.
             * @param {number} amount - The number to format.
             * @returns {string} The formatted currency string.
             */
            const formatCurrency = (amount) => {
                return `₱ ${parseFloat(amount || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            };

            /**
             * Calculates and updates the payroll components (Basic Pay, Overtime Pay, etc.)
             * and the Gross Pay (After Gov. Contributions) based on user inputs in the payroll input modal.
             * Also updates the payroll summary table within the modal.
             * @param {boolean} isEditMode - True if called from the edit modal, false otherwise.
             */
            const calculatePayroll = (isEditMode = false) => {
                const salaryRateInput = isEditMode ? editPayrollEmployeeSalaryRateInput : payrollEmployeeSalaryRateInput;
                const workingDaysInputEl = isEditMode ? editWorkingDaysInput : workingDaysInput;
                const overtimeHrsInputEl = isEditMode ? editOvertimeHrsInput : overtimeHrsInput;
                const sundayHolidayDutyInputEl = isEditMode ? editSundayHolidayDutyInput : sundayHolidayDutyInput;
                const nightShiftWorkDaysInputEl = isEditMode ? editNightShiftWorkDaysInput : nightShiftWorkDaysInput;
                const nightShiftOvertimeHrsInputEl = isEditMode ? editNightShiftOvertimeHrsInput : nightShiftOvertimeHrsInput;
                const sssContributionInputEl = isEditMode ? editPayrollHiddenSssContributionInput : payrollHiddenSssContributionInput;
                const phContributionInputEl = isEditMode ? editPayrollHiddenPhContributionInput : payrollHiddenPhContributionInput;
                const pagibigContributionInputEl = isEditMode ? editPayrollHiddenPagibigContributionInput : payrollHiddenPagibigContributionInput;
                const summaryTableBodyEl = isEditMode ? editPayrollSummaryTableBody : payrollSummaryTableBody;

                const salaryRate = parseFloat(salaryRateInput.value || 0); // This is assumed to be the DAILY salary rate
                const workingDays = parseFloat(workingDaysInputEl.value || 0);
                const overtimeHrs = parseFloat(overtimeHrsInputEl.value || 0);
                const sundayHolidayDuty = parseFloat(sundayHolidayDutyInputEl.value || 0);
                const nightShiftWorkDays = parseFloat(nightShiftWorkDaysInputEl.value || 0); // Represents full 8-hour night shifts
                const nightShiftOvertimeHrs = parseFloat(nightShiftOvertimeHrsInputEl.value || 0);

                // Get government contributions (already loaded into hidden inputs)
                const sssContribution = parseFloat(sssContributionInputEl.value || 0);
                const phContribution = parseFloat(phContributionInputEl.value || 0);
                const pagibigContribution = parseFloat(pagibigContributionInputEl.value || 0);

                // Constants for calculations
                const dailyRate = salaryRate; // Daily rate is directly from the employee's salaryRate
                const dailyWorkingHours = 8; // Assuming 8 hours per day
                const hourlyRate = dailyRate / dailyWorkingHours; // Hourly rate based on daily rate

                // --- Individual Payroll Component Calculations ---

                // Basic Pay: Daily Rate multiplied by the number of working days
                const basicPay = dailyRate * workingDays;

                // Overtime Pay: Overtime Hours * Hourly Rate * 125% (standard overtime premium)
                const overtimePay = overtimeHrs * hourlyRate * 1.25;

                // Sunday/Holiday Pay: Sunday/Holiday Duty Hours * Hourly Rate * 130% (standard premium for working on Sundays/Holidays)
                const sundayHolidayPay = sundayHolidayDuty * hourlyRate * 1.30;

                // Night Shift Differential: Night Shift Work Days * Daily Working Hours * Hourly Rate * 10% (night shift premium)
                // Assumes each 'Night Shift Work Day' is a full 8-hour shift.
                const nightShiftDifferential = nightShiftWorkDays * dailyWorkingHours * hourlyRate * 0.10;

                // Night Shift Overtime Pay: Night Shift Overtime Hours * Hourly Rate * 137.5% (125% OT premium on top of 10% night diff)
                // Calculation: (Hourly Rate * 1.10 for night shift) * 1.25 for overtime = Hourly Rate * 1.375
                const nightShiftOvertimePay = nightShiftOvertimeHrs * hourlyRate * 1.375;

                // Calculate Gross Earnings (before government deductions)
                const grossEarningsBeforeGovt = basicPay + overtimePay + sundayHolidayPay + nightShiftDifferential + nightShiftOvertimePay;

                // Calculate Total Government Contributions
                const totalGovtContributions = sssContribution + phContribution + pagibigContribution;

                // Calculate Gross Pay (After Gov. Contributions)
                const grossPayAfterGovt = grossEarningsBeforeGovt - totalGovtContributions;

                // --- Update Payroll Summary Table ---
                if (summaryTableBodyEl) summaryTableBodyEl.innerHTML = ''; // Clear existing rows

                const addRow = (label, value) => {
                    if (summaryTableBodyEl) {
                        const row = summaryTableBodyEl.insertRow();
                        row.innerHTML = `
                            <td class="py-2 px-4 text-left">${label}</td>
                            <td class="py-2 px-4 text-right">${formatCurrency(value)}</td>
                        `;
                    }
                };

                // Input Data
                addRow('Working Days', workingDays);
                addRow('Overtime Hours', overtimeHrs);
                addRow('Sunday/Holiday Duty (Hrs)', sundayHolidayDuty);
                addRow('Night Shift Work Days', nightShiftWorkDays);
                addRow('Night Shift Overtime Hrs', nightShiftOvertimeHrs);
                
                // Calculated Components
                addRow('Basic Pay', basicPay);
                addRow('Overtime Pay', overtimePay);
                addRow('Sunday/Holiday Pay', sundayHolidayPay);
                addRow('Night Shift Differential', nightShiftDifferential);
                addRow('Night Shift Overtime Pay', nightShiftOvertimePay);
                addRow('---', '---'); // Separator
                addRow('Gross Earnings (Before Gov. Contributions)', grossEarningsBeforeGovt);
                addRow('SSS Contribution', sssContribution);
                addRow('PhilHealth Contribution', phContribution);
                addRow('Pag-IBIG Contribution', pagibigContribution);
                addRow('---', '---'); // Separator
                addRow('Gross Pay (After Gov. Contributions)', grossPayAfterGovt);
            };

            /**
             * Opens the Payroll Input Modal for a specific employee and populates employee details.
             * @param {string} docId - The Firestore document ID of the employee.
             */
            window.openPayrollInputModal = async (docId) => {
                if (!userId) {
                    console.warn("User not authenticated. Cannot open payroll input.");
                    return;
                }
                try {
                    const employeeRef = doc(db, `/artifacts/${appId}/public/data/employees`, docId);
                    const employeeSnap = await getDoc(employeeRef);

                    if (employeeSnap.exists()) {
                        const employeeData = employeeSnap.data();
                        if (payrollEmployeeNameSpan) payrollEmployeeNameSpan.textContent = employeeData.fullName || '';
                        if (payrollEmployeeIdSpan) payrollEmployeeIdSpan.textContent = employeeData.employeeId || docId;
                        if (payrollEmployeeDocIdInput) payrollEmployeeDocIdInput.value = docId; // Store the employee's Firestore doc ID
                        if (payrollEmployeeSalaryRateInput) payrollEmployeeSalaryRateInput.value = parseFloat(employeeData.salaryRate || 0);

                        // Populate government contributions into hidden inputs
                        const sss = parseFloat(employeeData.sssContribution || 0);
                        const ph = parseFloat(employeeData.phContribution || 0);
                        const pagibig = parseFloat(employeeData.pagibigContribution || 0);

                        // Ensure these elements exist before setting their values
                        if (payrollHiddenSssContributionInput) payrollHiddenSssContributionInput.value = sss;
                        if (payrollHiddenPhContributionInput) payrollHiddenPhContributionInput.value = ph;
                        if (payrollHiddenPagibigContributionInput) payrollHiddenPagibigContributionInput.value = pagibig;

                        // Reset input fields
                        if (workingDaysInput) workingDaysInput.value = 0;
                        if (overtimeHrsInput) overtimeHrsInput.value = 0;
                        if (sundayHolidayDutyInput) sundayHolidayDutyInput.value = 0;
                        if (nightShiftWorkDaysInput) nightShiftWorkDaysInput.value = 0;
                        if (nightShiftOvertimeHrsInput) nightShiftOvertimeHrsInput.value = 0;
                        
                        calculatePayroll(false); // Initial calculation with zero inputs, but including pre-filled gov contributions

                        if (payrollInputModal) payrollInputModal.classList.remove('hidden');
                    } else {
                        console.error("No such employee document for payroll input!");
                    }
                } catch (e) {
                    console.error("Error fetching employee for payroll input: ", e);
                }
            };

            // Event listeners for payroll input fields to trigger calculation
            if (workingDaysInput) workingDaysInput.addEventListener('input', () => calculatePayroll(false));
            if (overtimeHrsInput) overtimeHrsInput.addEventListener('input', () => calculatePayroll(false));
            if (sundayHolidayDutyInput) sundayHolidayDutyInput.addEventListener('input', () => calculatePayroll(false));
            if (nightShiftWorkDaysInput) nightShiftWorkDaysInput.addEventListener('input', () => calculatePayroll(false));
            if (nightShiftOvertimeHrsInput) nightShiftOvertimeHrsInput.addEventListener('input', () => calculatePayroll(false));

            // Event listener for closing payroll input modal
            if (cancelPayrollInputButton) {
                cancelPayrollInputButton.addEventListener('click', () => {
                    if (payrollInputModal) payrollInputModal.classList.add('hidden');
                });
            }

            // Event listener for saving payroll data
            if (payrollInputForm) {
                payrollInputForm.addEventListener('submit', async (event) => {
                    event.preventDefault(); // Prevent default form submission

                    if (!userId) {
                        console.error("User not authenticated. Cannot save payroll record.");
                        return;
                    }

                    // Re-calculate to ensure latest values are used before saving
                    calculatePayroll(false); 

                    const employeeDocId = payrollEmployeeDocIdInput.value;
                    const employeeName = payrollEmployeeNameSpan.textContent;
                    const employeeId = payrollEmployeeIdSpan.textContent;
                    const salaryRate = parseFloat(payrollEmployeeSalaryRateInput.value || 0);

                    // Re-calculate values to ensure they are fresh for saving
                    const workingDays = parseFloat(workingDaysInput.value || 0);
                    const overtimeHrs = parseFloat(overtimeHrsInput.value || 0);
                    const sundayHolidayDuty = parseFloat(sundayHolidayDutyInput.value || 0);
                    const nightShiftWorkDays = parseFloat(nightShiftWorkDaysInput.value || 0);
                    const nightShiftOvertimeHrs = parseFloat(nightShiftOvertimeHrsInput.value || 0);
                    const sssContribution = parseFloat(payrollHiddenSssContributionInput.value || 0);
                    const phContribution = parseFloat(payrollHiddenPhContributionInput.value || 0);
                    const pagibigContribution = parseFloat(payrollHiddenPagibigContributionInput.value || 0);

                    const dailyRate = salaryRate;
                    const dailyWorkingHours = 8;
                    const hourlyRate = dailyRate / dailyWorkingHours;

                    const basicPay = dailyRate * workingDays;
                    const overtimePay = overtimeHrs * hourlyRate * 1.25;
                    const sundayHolidayPay = sundayHolidayDuty * hourlyRate * 1.30;
                    const nightShiftDifferential = nightShiftWorkDays * dailyWorkingHours * hourlyRate * 0.10;
                    const nightShiftOvertimePay = nightShiftOvertimeHrs * hourlyRate * 1.375;
                    const grossEarningsBeforeGovt = basicPay + overtimePay + sundayHolidayPay + nightShiftDifferential + nightShiftOvertimePay;
                    const totalGovtContributions = sssContribution + phContribution + pagibigContribution;
                    const grossPayAfterGovt = grossEarningsBeforeGovt - totalGovtContributions;


                    const payrollRecord = {
                        employeeDocId: employeeDocId,
                        employeeId: employeeId,
                        employeeName: employeeName,
                        salaryRate: salaryRate,
                        workingDays: workingDays,
                        overtimeHrs: overtimeHrs,
                        sundayHolidayDuty: sundayHolidayDuty,
                        nightShiftWorkDays: nightShiftWorkDays,
                        nightShiftOvertimeHrs: nightShiftOvertimeHrs,
                        basicPay: basicPay,
                        overtimePay: overtimePay,
                        sundayHolidayPay: sundayHolidayPay,
                        nightShiftDifferential: nightShiftDifferential,
                        nightShiftOvertimePay: nightShiftOvertimePay,
                        
                        // Save the government contributions with the payroll record
                        sssContribution: sssContribution,
                        phContribution: phContribution,
                        pagibigContribution: pagibigContribution,

                        grossPay: grossPayAfterGovt, // This is now gross pay AFTER gov deductions
                        payrollDate: new Date(),
                        processedByUserId: userId
                    };

                    try {
                        // Save the payroll record to a new collection
                        await addDoc(collection(db, `/artifacts/${appId}/public/data/payroll_records`), payrollRecord);
                        console.log("Payroll record saved successfully!", payrollRecord);
                        if (payrollInputModal) payrollInputModal.classList.add('hidden'); // Hide modal after saving
                        // Optionally, show a success message to the user
                    } catch (e) {
                        console.error("Error saving payroll record: ", e);
                        // Optionally, show an error message to the user
                    }
                });
            }

            /**
             * Opens the Edit Payroll Modal and populates it with the selected payroll record's data.
             * @param {string} docId - The Firestore document ID of the payroll record to edit.
             */
            window.openEditPayrollModal = async (docId) => {
                if (!userId) {
                    console.warn("User not authenticated. Cannot edit payroll record.");
                    return;
                }
                try {
                    const payrollRef = doc(db, `/artifacts/${appId}/public/data/payroll_records`, docId);
                    const payrollSnap = await getDoc(payrollRef);

                    if (payrollSnap.exists()) {
                        const payrollData = payrollSnap.data();
                        const employeeRef = doc(db, `/artifacts/${appId}/public/data/employees`, payrollData.employeeDocId);
                        const employeeSnap = await getDoc(employeeRef);
                        const employeeData = employeeSnap.exists() ? employeeSnap.data() : {};

                        if (editPayrollDocIdInput) editPayrollDocIdInput.value = docId;
                        if (editPayrollEmployeeDocIdInput) editPayrollEmployeeDocIdInput.value = payrollData.employeeDocId;
                        if (editPayrollEmployeeNameSpan) editPayrollEmployeeNameSpan.textContent = employeeData.fullName || payrollData.employeeName || 'N/A';
                        if (editPayrollEmployeeIdSpan) editPayrollEmployeeIdSpan.textContent = employeeData.employeeId || payrollData.employeeId || 'N/A';
                        if (editPayrollEmployeeSalaryRateInput) editPayrollEmployeeSalaryRateInput.value = parseFloat(payrollData.salaryRate || 0);

                        if (editWorkingDaysInput) editWorkingDaysInput.value = parseFloat(payrollData.workingDays || 0);
                        if (editOvertimeHrsInput) editOvertimeHrsInput.value = parseFloat(payrollData.overtimeHrs || 0);
                        if (editSundayHolidayDutyInput) editSundayHolidayDutyInput.value = parseFloat(payrollData.sundayHolidayDuty || 0);
                        if (editNightShiftWorkDaysInput) editNightShiftWorkDaysInput.value = parseFloat(payrollData.nightShiftWorkDays || 0);
                        if (editNightShiftOvertimeHrsInput) editNightShiftOvertimeHrsInput.value = parseFloat(payrollData.nightShiftOvertimeHrs || 0);

                        if (editPayrollHiddenSssContributionInput) editPayrollHiddenSssContributionInput.value = parseFloat(payrollData.sssContribution || 0);
                        if (editPayrollHiddenPhContributionInput) editPayrollHiddenPhContributionInput.value = parseFloat(payrollData.phContribution || 0);
                        if (editPayrollHiddenPagibigContributionInput) editPayrollHiddenPagibigContributionInput.value = parseFloat(payrollData.pagibigContribution || 0);

                        calculatePayroll(true); // Calculate for edit modal

                        if (editPayrollModal) editPayrollModal.classList.remove('hidden');
                    } else {
                        console.error("No such payroll record document!");
                    }
                } catch (e) {
                    console.error("Error fetching payroll record for edit: ", e);
                }
            };

            // Event listeners for edit payroll input fields to trigger calculation
            if (editWorkingDaysInput) editWorkingDaysInput.addEventListener('input', () => calculatePayroll(true));
            if (editOvertimeHrsInput) editOvertimeHrsInput.addEventListener('input', () => calculatePayroll(true));
            if (editSundayHolidayDutyInput) editSundayHolidayDutyInput.addEventListener('input', () => calculatePayroll(true));
            if (editNightShiftWorkDaysInput) editNightShiftWorkDaysInput.addEventListener('input', () => calculatePayroll(true));
            if (editNightShiftOvertimeHrsInput) editNightShiftOvertimeHrsInput.addEventListener('input', () => calculatePayroll(true));

            // Event listener for closing edit payroll modal
            if (cancelEditPayrollButton) {
                cancelEditPayrollButton.addEventListener('click', () => {
                    if (editPayrollModal) editPayrollModal.classList.add('hidden');
                });
            }

            // Event listener for updating payroll data
            if (editPayrollForm) {
                editPayrollForm.addEventListener('submit', async (event) => {
                    event.preventDefault();

                    if (!userId) {
                        console.error("User not authenticated. Cannot update payroll record.");
                        return;
                    }

                    calculatePayroll(true); // Re-calculate to ensure latest values are used before saving

                    const docId = editPayrollDocIdInput.value;
                    const payrollRef = doc(db, `/artifacts/${appId}/public/data/payroll_records`, docId);

                    const employeeDocId = editPayrollEmployeeDocIdInput.value;
                    const employeeName = editPayrollEmployeeNameSpan.textContent;
                    const employeeId = editPayrollEmployeeIdSpan.textContent;
                    const salaryRate = parseFloat(editPayrollEmployeeSalaryRateInput.value || 0);

                    const workingDays = parseFloat(editWorkingDaysInput.value || 0);
                    const overtimeHrs = parseFloat(editOvertimeHrsInput.value || 0);
                    const sundayHolidayDuty = parseFloat(editSundayHolidayDutyInput.value || 0);
                    const nightShiftWorkDays = parseFloat(editNightShiftWorkDaysInput.value || 0);
                    const nightShiftOvertimeHrs = parseFloat(editNightShiftOvertimeHrsInput.value || 0);
                    const sssContribution = parseFloat(editPayrollHiddenSssContributionInput.value || 0);
                    const phContribution = parseFloat(editPayrollHiddenPhContributionInput.value || 0);
                    const pagibigContribution = parseFloat(editPayrollHiddenPagibigContributionInput.value || 0);

                    const dailyRate = salaryRate;
                    const dailyWorkingHours = 8;
                    const hourlyRate = dailyRate / dailyWorkingHours;

                    const basicPay = dailyRate * workingDays;
                    const overtimePay = overtimeHrs * hourlyRate * 1.25;
                    const sundayHolidayPay = sundayHolidayDuty * hourlyRate * 1.30;
                    const nightShiftDifferential = nightShiftWorkDays * dailyWorkingHours * hourlyRate * 0.10;
                    const nightShiftOvertimePay = nightShiftOvertimeHrs * hourlyRate * 1.375;
                    const grossEarningsBeforeGovt = basicPay + overtimePay + sundayHolidayPay + nightShiftDifferential + nightShiftOvertimePay;
                    const totalGovtContributions = sssContribution + phContribution + pagibigContribution;
                    const grossPayAfterGovt = grossEarningsBeforeGovt - totalGovtContributions;

                    const updatedPayrollRecord = {
                        employeeDocId: employeeDocId,
                        employeeId: employeeId,
                        employeeName: employeeName,
                        salaryRate: salaryRate,
                        workingDays: workingDays,
                        overtimeHrs: overtimeHrs,
                        sundayHolidayDuty: sundayHolidayDuty,
                        nightShiftWorkDays: nightShiftWorkDays,
                        nightShiftOvertimeHrs: nightShiftOvertimeHrs,
                        basicPay: basicPay,
                        overtimePay: overtimePay,
                        sundayHolidayPay: sundayHolidayPay,
                        nightShiftDifferential: nightShiftDifferential,
                        nightShiftOvertimePay: nightShiftOvertimePay,
                        sssContribution: sssContribution,
                        phContribution: phContribution,
                        pagibigContribution: pagibigContribution,
                        grossPay: grossPayAfterGovt,
                        // Update payrollDate if needed, or keep original
                        // processedByUserId: userId // Keep original or update if desired
                    };

                    try {
                        await updateDoc(payrollRef, updatedPayrollRecord);
                        console.log("Payroll record updated successfully!", updatedPayrollRecord);
                        if (editPayrollModal) editPayrollModal.classList.add('hidden');
                    } catch (e) {
                        console.error("Error updating payroll record: ", e);
                    }
                });
            }


            /**
             * Calculates and updates the total other deductions and net pay based on user inputs
             * in the deductions input modal.
             * @param {boolean} isEditMode - True if called from the edit modal, false otherwise.
             */
            const calculateDeductions = (isEditMode = false) => {
                const grossPaySpan = isEditMode ? editDeductionsGrossPaySpan : deductionsGrossPaySpan;
                const govtLoanInputEl = isEditMode ? editGovtLoanInput : govtLoanInput;
                const coopShareInputEl = isEditMode ? editCoopShareInput : coopShareInput;
                const withholdingTaxInputEl = isEditMode ? editWithholdingTaxInput : withholdingTaxInput;
                const unpaidLoanInputEl = isEditMode ? editUnpaidLoanInput : unpaidLoanInput;
                const coop2025InputEl = isEditMode ? editCoop2025Input : coop2025Input;
                const caVoucherInputEl = isEditMode ? editCaVoucherInput : caVoucherInput;
                const dailyValeInputEl = isEditMode ? editDailyValeInput : dailyValeInput;
                const othersDeductionInputEl = isEditMode ? editOthersDeductionInput : othersDeductionInput;
                const totalDeductionsSpan = isEditMode ? editCalculatedTotalDeductionsSpan : calculatedTotalDeductionsSpan;
                const netPaySpan = isEditMode ? editCalculatedNetPaySpan : calculatedNetPaySpan;

                // Gross pay here is already the amount AFTER government contributions
                const grossPay = parseFloat(grossPaySpan.textContent.replace('₱ ', '').replace(/,/g, '') || 0);
                
                const govtLoan = parseFloat(govtLoanInputEl.value || 0);
                const coopShare = parseFloat(coopShareInputEl.value || 0);
                const withholdingTax = parseFloat(withholdingTaxInputEl.value || 0);
                const unpaidLoan = parseFloat(unpaidLoanInputEl.value || 0);
                const coop2025 = parseFloat(coop2025InputEl.value || 0);
                const caVoucher = parseFloat(caVoucherInputEl.value || 0);
                const dailyVale = parseFloat(dailyValeInputEl.value || 0);
                const othersDeduction = parseFloat(othersDeductionInputEl.value || 0);

                // Total Deductions in this modal now only represent "other" deductions
                const totalOtherDeductions = govtLoan + coopShare + withholdingTax + unpaidLoan + coop2025 + caVoucher + dailyVale + othersDeduction;

                const netPay = grossPay - totalOtherDeductions;

                // Update display
                if (totalDeductionsSpan) totalDeductionsSpan.textContent = `₱ ${totalOtherDeductions.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                if (netPaySpan) netPaySpan.textContent = `₱ ${netPay.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            };

            /**
             * Opens the Deductions Input Modal for a specific employee and populates employee details
             * and their latest gross pay (after government contributions).
             * @param {string} employeeDocId - The Firestore document ID of the employee.
             */
            window.openDeductionsModal = async (employeeDocId) => {
                if (!userId) {
                    console.warn("User not authenticated. Cannot open deductions input.");
                    return;
                }
                try {
                    const employeeRef = doc(db, `/artifacts/${appId}/public/data/employees`, employeeDocId);
                    const employeeSnap = await getDoc(employeeRef);

                    if (employeeSnap.exists()) {
                        const employeeData = employeeSnap.data();
                        if (deductionsEmployeeNameSpan) deductionsEmployeeNameSpan.textContent = employeeData.fullName || '';
                        if (deductionsEmployeeIdSpan) deductionsEmployeeIdSpan.textContent = employeeData.employeeId || employeeDocId;
                        if (deductionsEmployeeDocIdInput) deductionsEmployeeDocIdInput.value = employeeDocId;

                        // Fetch the latest gross pay (after government contributions) from payroll_records
                        const payrollRecordsQuery = query(
                            collection(db, `/artifacts/${appId}/public/data/payroll_records`),
                            where("employeeDocId", "==", employeeDocId),
                            orderBy("payrollDate", "desc"),
                            limit(1)
                        );
                        const payrollSnapshot = await getDocs(payrollRecordsQuery);
                        let latestGrossPay = 0; // This will be gross pay AFTER gov contributions
                        let latestPayrollDocId = null;

                        if (!payrollSnapshot.empty) {
                            const latestPayrollRecord = payrollSnapshot.docs[0].data();
                            latestGrossPay = latestPayrollRecord.grossPay || 0;
                            latestPayrollDocId = payrollSnapshot.docs[0].id;
                        } else {
                            console.warn(`No payroll records found for employee ${employeeData.fullName}. Gross Pay set to 0.`);
                        }
                        
                        if (deductionsGrossPaySpan) deductionsGrossPaySpan.textContent = `₱ ${latestGrossPay.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                        if (deductionsEmployeePayrollDocIdInput) deductionsEmployeePayrollDocIdInput.value = latestPayrollDocId; // Store the associated payroll record ID

                        // Reset other deduction input fields
                        if (govtLoanInput) govtLoanInput.value = 0;
                        if (coopShareInput) coopShareInput.value = 0;
                        if (withholdingTaxInput) withholdingTaxInput.value = 0;
                        if (unpaidLoanInput) unpaidLoanInput.value = 0;
                        if (coop2025Input) coop2025Input.value = 0;
                        if (caVoucherInput) caVoucherInput.value = 0;
                        if (dailyValeInput) dailyValeInput.value = 0;
                        if (othersDeductionInput) othersDeductionInput.value = 0;

                        calculateDeductions(false); // Initial calculation with all values

                        if (deductionsInputModal) deductionsInputModal.classList.remove('hidden');
                    } else {
                        console.error("No such employee document for deductions input!");
                    }
                } catch (e) {
                    console.error("Error fetching employee for deductions input: ", e);
                }
            };

            // Event listeners for deduction input fields to trigger calculation
            if (govtLoanInput) govtLoanInput.addEventListener('input', () => calculateDeductions(false));
            if (coopShareInput) coopShareInput.addEventListener('input', () => calculateDeductions(false));
            if (withholdingTaxInput) withholdingTaxInput.addEventListener('input', () => calculateDeductions(false));
            if (unpaidLoanInput) unpaidLoanInput.addEventListener('input', () => calculateDeductions(false));
            if (coop2025Input) coop2025Input.addEventListener('input', () => calculateDeductions(false));
            if (caVoucherInput) caVoucherInput.addEventListener('input', () => calculateDeductions(false));
            if (dailyValeInput) dailyValeInput.addEventListener('input', () => calculateDeductions(false));
            if (othersDeductionInput) othersDeductionInput.addEventListener('input', () => calculateDeductions(false));

            // Event listener for closing deductions input modal
            if (cancelDeductionsInputButton) {
                cancelDeductionsInputButton.addEventListener('click', () => {
                    if (deductionsInputModal) deductionsInputModal.classList.add('hidden');
                });
            }

            // Event listener for saving deductions data
            if (deductionsInputForm) {
                deductionsInputForm.addEventListener('submit', async (event) => {
                    event.preventDefault();

                    if (!userId) {
                        console.error("User not authenticated. Cannot save deduction record.");
                        return;
                    }

                    calculateDeductions(false); // Re-calculate to ensure latest values are used before saving

                    const employeeDocId = deductionsEmployeeDocIdInput.value;
                    const payrollDocId = deductionsEmployeePayrollDocIdInput.value;
                    const employeeName = deductionsEmployeeNameSpan.textContent;
                    const employeeId = deductionsEmployeeIdSpan.textContent;
                    // grossPay here is already the amount AFTER government contributions
                    const grossPay = parseFloat(deductionsGrossPaySpan.textContent.replace('₱ ', '').replace(/,/g, ''));

                    const deductionRecord = {
                        employeeDocId: employeeDocId,
                        payrollDocId: payrollDocId, // Link to the specific payroll record
                        employeeId: employeeId,
                        employeeName: employeeName,
                        grossPay: grossPay, // This is gross pay AFTER government contributions
                        
                        // Government contributions are no longer part of this deduction record,
                        // as they are now deducted from gross pay directly.
                        // For historical tracking, they are stored with the payroll record.
                        
                        govtLoan: parseFloat(govtLoanInput.value || 0),
                        coopShare: parseFloat(coopShareInput.value || 0),
                        withholdingTax: parseFloat(withholdingTaxInput.value || 0),
                        unpaidLoan: parseFloat(unpaidLoanInput.value || 0),
                        coop2025: parseFloat(coop2025Input.value || 0),
                        caVoucher: parseFloat(caVoucherInput.value || 0),
                        dailyVale: parseFloat(dailyValeInput.value || 0),
                        othersDeduction: parseFloat(othersDeductionInput.value || 0),
                        totalDeductions: parseFloat(calculatedTotalDeductionsSpan.textContent.replace('₱ ', '').replace(/,/g, '')), // This is now only "other" deductions
                        netPay: parseFloat(calculatedNetPaySpan.textContent.replace('₱ ', '').replace(/,/g, '')),
                        deductionDate: new Date(),
                        processedByUserId: userId
                    };

                    try {
                        await addDoc(collection(db, `/artifacts/${appId}/public/data/deduction_records`), deductionRecord);
                        console.log("Deduction record saved successfully!", deductionRecord);
                        if (deductionsInputModal) deductionsInputModal.classList.add('hidden');
                    } catch (e) {
                        console.error("Error saving deduction record: ", e);
                    }
                });
            }

            /**
             * Opens the Edit Deductions Modal and populates it with the selected deduction record's data.
             * @param {string} docId - The Firestore document ID of the deduction record to edit.
             */
            window.openEditDeductionsModal = async (docId) => {
                if (!userId) {
                    console.warn("User not authenticated. Cannot edit deduction record.");
                    return;
                }
                try {
                    const deductionRef = doc(db, `/artifacts/${appId}/public/data/deduction_records`, docId);
                    const deductionSnap = await getDoc(deductionRef);

                    if (deductionSnap.exists()) {
                        const deductionData = deductionSnap.data();
                        const employeeRef = doc(db, `/artifacts/${appId}/public/data/employees`, deductionData.employeeDocId);
                        const employeeSnap = await getDoc(employeeRef);
                        const employeeData = employeeSnap.exists() ? employeeSnap.data() : {};

                        if (editDeductionsDocIdInput) editDeductionsDocIdInput.value = docId;
                        if (editDeductionsEmployeeDocIdInput) editDeductionsEmployeeDocIdInput.value = deductionData.employeeDocId;
                        if (editDeductionsEmployeePayrollDocIdInput) editDeductionsEmployeePayrollDocIdInput.value = deductionData.payrollDocId || '';
                        if (editDeductionsEmployeeNameSpan) editDeductionsEmployeeNameSpan.textContent = employeeData.fullName || deductionData.employeeName || 'N/A';
                        if (editDeductionsEmployeeIdSpan) editDeductionsEmployeeIdSpan.textContent = employeeData.employeeId || deductionData.employeeId || 'N/A';
                        if (editDeductionsGrossPaySpan) editDeductionsGrossPaySpan.textContent = `₱ ${parseFloat(deductionData.grossPay || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

                        if (editGovtLoanInput) editGovtLoanInput.value = parseFloat(deductionData.govtLoan || 0);
                        if (editCoopShareInput) editCoopShareInput.value = parseFloat(deductionData.coopShare || 0);
                        if (editWithholdingTaxInput) editWithholdingTaxInput.value = parseFloat(deductionData.withholdingTax || 0);
                        if (editUnpaidLoanInput) editUnpaidLoanInput.value = parseFloat(deductionData.unpaidLoan || 0);
                        if (editCoop2025Input) editCoop2025Input.value = parseFloat(deductionData.coop2025 || 0);
                        if (editCaVoucherInput) editCaVoucherInput.value = parseFloat(deductionData.caVoucher || 0);
                        if (editDailyValeInput) editDailyValeInput.value = parseFloat(deductionData.dailyVale || 0);
                        if (editOthersDeductionInput) editOthersDeductionInput.value = parseFloat(deductionData.othersDeduction || 0);

                        calculateDeductions(true); // Calculate for edit modal

                        if (editDeductionsModal) editDeductionsModal.classList.remove('hidden');
                    } else {
                        console.error("No such deduction record document!");
                    }
                } catch (e) {
                    console.error("Error fetching deduction record for edit: ", e);
                }
            };

            // Event listeners for edit deduction input fields to trigger calculation
            if (editGovtLoanInput) editGovtLoanInput.addEventListener('input', () => calculateDeductions(true));
            if (editCoopShareInput) editCoopShareInput.addEventListener('input', () => calculateDeductions(true));
            if (editWithholdingTaxInput) editWithholdingTaxInput.addEventListener('input', () => calculateDeductions(true));
            if (editUnpaidLoanInput) editUnpaidLoanInput.addEventListener('input', () => calculateDeductions(true));
            if (editCoop2025Input) editCoop2025Input.addEventListener('input', () => calculateDeductions(true));
            if (editCaVoucherInput) editCaVoucherInput.addEventListener('input', () => calculateDeductions(true));
            if (editDailyValeInput) editDailyValeInput.addEventListener('input', () => calculateDeductions(true));
            if (editOthersDeductionInput) editOthersDeductionInput.addEventListener('input', () => calculateDeductions(true));

            // Event listener for closing edit deductions modal
            if (cancelEditDeductionsButton) {
                cancelEditDeductionsButton.addEventListener('click', () => {
                    if (editDeductionsModal) editDeductionsModal.classList.add('hidden');
                });
            }

            // Event listener for updating deductions data
            if (editDeductionsForm) {
                editDeductionsForm.addEventListener('submit', async (event) => {
                    event.preventDefault();

                    if (!userId) {
                        console.error("User not authenticated. Cannot update deduction record.");
                        return;
                    }

                    calculateDeductions(true); // Re-calculate to ensure latest values are used before saving

                    const docId = editDeductionsDocIdInput.value;
                    const deductionRef = doc(db, `/artifacts/${appId}/public/data/deduction_records`, docId);

                    const employeeDocId = editDeductionsEmployeeDocIdInput.value;
                    const payrollDocId = editDeductionsEmployeePayrollDocIdInput.value;
                    const employeeName = editDeductionsEmployeeNameSpan.textContent;
                    const employeeId = editDeductionsEmployeeIdSpan.textContent;
                    const grossPay = parseFloat(editDeductionsGrossPaySpan.textContent.replace('₱ ', '').replace(/,/g, ''));

                    const updatedDeductionRecord = {
                        employeeDocId: employeeDocId,
                        payrollDocId: payrollDocId,
                        employeeId: employeeId,
                        employeeName: employeeName,
                        grossPay: grossPay,
                        govtLoan: parseFloat(editGovtLoanInput.value || 0),
                        coopShare: parseFloat(editCoopShareInput.value || 0),
                        withholdingTax: parseFloat(editWithholdingTaxInput.value || 0),
                        unpaidLoan: parseFloat(editUnpaidLoanInput.value || 0),
                        coop2025: parseFloat(editCoop2025Input.value || 0),
                        caVoucher: parseFloat(editCaVoucherInput.value || 0),
                        dailyVale: parseFloat(editDailyValeInput.value || 0),
                        othersDeduction: parseFloat(editOthersDeductionInput.value || 0),
                        totalDeductions: parseFloat(editCalculatedTotalDeductionsSpan.textContent.replace('₱ ', '').replace(/,/g, '')),
                        netPay: parseFloat(editCalculatedNetPaySpan.textContent.replace('₱ ', '').replace(/,/g, '')),
                        // deductionDate: new Date(), // Keep original or update if desired
                        // processedByUserId: userId // Keep original or update if desired
                    };

                    try {
                        await updateDoc(deductionRef, updatedDeductionRecord);
                        console.log("Deduction record updated successfully!", updatedDeductionRecord);
                        if (editDeductionsModal) editDeductionsModal.classList.add('hidden');
                    } catch (e) {
                        console.error("Error updating deduction record: ", e);
                    }
                });
            }


            // Add console.log to confirm button clicks
            if (navButtons) {
                navButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const targetId = button.dataset.target;
                        console.log(`Nav button clicked: ${targetId}`); // Diagnostic log
                        showContent(targetId);
                    });
                });
            }

            // Event listener for the new payroll summary department filter dropdown
            if (payrollSummaryDepartmentFilter) {
                payrollSummaryDepartmentFilter.addEventListener('change', (event) => {
                    const selectedDepartment = event.target.value;
                    fetchPayrollSummary(selectedDepartment); // Re-fetch summary with filter
                });
            }
        });
    </script>
</body>
</html>
