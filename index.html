<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DLV Electrical Services Co. Payroll System</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6;
        }
        .sidebar {
            width: 250px;
            background-color: #1a202c; /* Darker background for sidebar */
            color: #e2e8f0;
            padding: 1.5rem;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            position: fixed;
            height: 100%;
            display: flex;
            flex-direction: column;
            border-top-right-radius: 10px;
            border-bottom-right-radius: 10px;
        }
        .main-content {
            margin-left: 250px;
            padding: 2rem;
            flex-grow: 1;
            background-color: #ffffff;
            min-height: 100vh;
            border-top-left-radius: 10px;
            border-bottom-left-radius: 10px;
            box-shadow: -2px 0 5px rgba(0,0,0,0.05);
        }
        .nav-button {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            margin-bottom: 0.75rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
            cursor: pointer;
        }
        .nav-button:hover {
            background-color: #2d3748; /* Slightly lighter dark on hover */
            color: #a0aec0;
        }
        .nav-button.active {
            background-color: #4a5568; /* Active state background */
            color: #ffffff;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .nav-button svg {
            margin-right: 0.75rem;
            width: 20px;
            height: 20px;
        }
        .section-content {
            display: none;
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .section-content.active {
            display: block;
        }
        .admin-button {
            background-color: #4299e1; /* Blue for admin button */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
            margin-top: auto; /* Pushes button to the bottom */
            text-align: center;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .admin-button:hover {
            background-color: #3182ce;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 2.5rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 500px; /* Increased max-width for more fields */
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            text-align: left; /* Align text left for forms */
        }
        .modal-content input, .modal-content select {
            width: calc(100% - 2rem);
            padding: 0.75rem 1rem;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid #cbd5e0;
            border-radius: 0.5rem;
            font-size: 1rem;
            display: block; /* Ensure inputs take full width */
        }
        .modal-content label {
            display: block;
            margin-top: 1rem;
            font-weight: 500;
            color: #4a5568;
        }
        .modal-content button {
            background-color: #4299e1;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
            cursor: pointer;
            margin-top: 1rem;
        }
        .modal-content button:hover {
            background-color: #3182ce;
        }
        .modal-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-close:hover,
        .modal-close:focus {
            color: black;
            text-decoration: none;
        }

        /* Specific styling for the Add Employee Modal */
        #add-employee-modal .modal-content {
            max-width: 600px; /* Wider for better form layout */
            padding: 2.5rem;
        }
        #add-employee-form .form-group {
            display: flex; /* Re-added flex for consistent vertical stacking */
            flex-direction: column; /* Stack label and input vertically */
            justify-content: flex-start; /* Align content to the top */
        }
        #add-employee-form .grid-cols-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        #add-employee-form .grid-cols-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        #add-employee-form input,
        #add-employee-form select {
            width: 100%; /* Make inputs fill their grid column */
            padding: 0.6rem 0.8rem; /* Slightly smaller padding for denser form */
            display: block; /* Ensure input/select is a block element */
            margin-top: 0.25rem; /* Small margin from label */
            margin-bottom: 0; /* No bottom margin, controlled by grid gap */
        }
        #add-employee-form label {
            display: block; /* Ensure label is a block element */
            margin-bottom: 0; /* Removed margin-bottom here, relying on input's margin-top */
            font-size: 0.9rem;
            color: #2d3748;
        }
        #add-employee-form button[type="submit"] {
            width: auto;
            margin-left: auto;
            margin-right: auto;
            display: block;
            margin-top: 2rem;
            background-color: #2f855a; /* Green for save button */
        }
        #add-employee-form button[type="submit"]:hover {
            background-color: #276749;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                border-radius: 0;
                padding: 1rem;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            }
            .nav-button {
                margin: 0.5rem;
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
            }
            .nav-button svg {
                margin-right: 0.5rem;
                width: 16px;
                height: 16px;
            }
            .main-content {
                margin-left: 0;
                padding: 1rem;
            }
            .admin-button {
                width: 100%;
                margin-top: 1rem;
            }
            .sidebar .nav-links {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                width: 100%;
            }
            .modal-content {
                padding: 1.5rem;
            }
            .modal-content input, .modal-content select {
                width: calc(100% - 1rem); /* Adjust for smaller padding */
                padding: 0.6rem 0.8rem;
            }
            #add-employee-modal .modal-content {
                max-width: 95%; /* Adjust max-width for small screens */
                padding: 1.5rem;
            }
            #add-employee-form .grid-cols-2,
            #add-employee-form .grid-cols-3 {
                grid-template-columns: 1fr; /* Stack columns on small screens */
            }
        }
    </style>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Define __app_id_global at the top-most scope possible, before any other Firebase-related definitions.
        // This ensures it's available when firebaseConfig is used and when window.fb.appId is set.
        let __app_id_global;
        if (typeof __app_id !== 'undefined') {
            __app_id_global = __app_id;
        } else {
            console.warn("Global __app_id not defined by environment. Using 'default-app-id'.");
            __app_id_global = 'default-app-id';
        }

        // Global variables for Firebase instances
        window.fb = {};
        window.fb.app = null;
        window.fb.db = null;
        window.fb.auth = null;
        window.fb.userId = null;
        window.fb.appId = __app_id_global; // Initialize appId with the global or fallback value
        window.fb.isAuthReady = false;

        // Firebase configuration provided by the user
        const firebaseConfig = {
            apiKey: "AIzaSyAYpApEwrgAsso-dJ-uTAX3AI4yRZBn9JU",
            authDomain: "payroll-aef73.firebaseapp.com",
            projectId: "payroll-aef73",
            storageBucket: "payroll-aef73.firebasestorage.app",
            messagingSenderId: "717714854870",
            appId: "1:717714854870:web:b1e7eb0dc82cd61dbc8a77",
            measurementId: "G-F31PSMN7RD"
        };

        // Initialize Firebase
        window.fb.app = initializeApp(firebaseConfig);
        window.fb.db = getFirestore(window.fb.app);
        window.fb.auth = getAuth(window.fb.app);

        // Authenticate user
        onAuthStateChanged(window.fb.auth, async (user) => {
            if (user) {
                window.fb.userId = user.uid;
                console.log("Firebase authenticated as:", user.uid);
            } else {
                // Sign in anonymously if no user is logged in
                try {
                    // Use __initial_auth_token if available, otherwise sign in anonymously
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(window.fb.auth, __initial_auth_token);
                        window.fb.userId = window.fb.auth.currentUser.uid;
                        console.log("Signed in with custom token.");
                    } else {
                        await signInAnonymously(window.fb.auth);
                        window.fb.userId = window.fb.auth.currentUser.uid;
                        console.log("Signed in anonymously.");
                    }
                } catch (error) {
                    console.error("Firebase authentication error:", error);
                    // Fallback to a random ID if authentication fails, though data won't persist securely
                    window.fb.userId = crypto.randomUUID();
                    console.warn("Using random user ID due to authentication failure. Data may not persist.");
                }
            }
            // Set isAuthReady after authentication is attempted
            window.fb.isAuthReady = true;
            // Dispatch a custom event to indicate Firebase is ready
            document.dispatchEvent(new CustomEvent('firebaseReady'));
        });

        // Expose Firestore functions globally for use in inline scripts
        window.fb.getFirestore = () => window.fb.db;
        window.fb.collection = collection;
        window.fb.addDoc = addDoc;
        window.fb.onSnapshot = onSnapshot;
        window.fb.query = query;
        window.fb.doc = doc;
        window.fb.deleteDoc = deleteDoc;
        window.fb.updateDoc = updateDoc;
    </script>
</head>
<body class="flex flex-col md:flex-row min-h-screen">

    <!-- Sidebar Navigation -->
    <aside class="sidebar">
        <div class="flex items-center mb-8">
            <svg class="w-8 h-8 mr-3 text-blue-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
            </svg>
            <h1 class="text-2xl font-bold text-white">DLV Payroll</h1>
        </div>

        <nav class="nav-links flex flex-col md:flex-col">
            <button class="nav-button active" data-section="dashboard">
                <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M2 10a8 8 0 018-8v8h8a8 8 0 01-8 8v-8H2z"></path>
                    <path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z"></path>
                </svg>
                Dashboard
            </button>
            <button class="nav-button" data-section="manage-employees">
                <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zm-6 9a7 7 0 0012 0H6.755z"></path>
                </svg>
                Manage Employees
            </button>
            <button class="nav-button" data-section="departments-sites">
                <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0113 3.414L16.586 7A2 2 0 0118 8.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1-3a1 1 0 100 2h2a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                </svg>
                Department/Sites
            </button>
            <button class="nav-button" data-section="payroll">
                <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 002-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 2a2 2 0 100 4 2 2 0 000-4z" clip-rule="evenodd"></path>
                </svg>
                Payroll
            </button>
        </nav>

        <button id="admin-login-btn" class="admin-button">
            Administrator Login
        </button>
    </aside>

    <!-- Main Content Area -->
    <main class="main-content">
        <h2 class="text-3xl font-bold text-gray-800 mb-8">Welcome, DLV Electrical Services Co.</h2>

        <!-- Dashboard Section -->
        <section id="dashboard-content" class="section-content active">
            <h3 class="text-2xl font-semibold text-gray-700 mb-4">Dashboard Overview</h3>
            <p class="text-gray-600">This section provides a quick overview of key payroll metrics, employee status, and upcoming tasks.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-6">
                <div class="bg-blue-50 p-6 rounded-lg shadow-md">
                    <h4 class="text-xl font-semibold text-blue-700 mb-2">Total Employees</h4>
                    <p id="total-employees-count" class="text-3xl font-bold text-blue-900">0</p>
                </div>
                <div class="bg-green-50 p-6 rounded-lg shadow-md">
                    <h4 class="text-xl font-semibold text-green-700 mb-2">Upcoming Payroll</h4>
                    <p class="text-3xl font-bold text-green-900">N/A</p>
                </div>
                <div class="bg-yellow-50 p-6 rounded-lg shadow-md">
                    <h4 class="text-xl font-semibold text-yellow-700 mb-2">Pending Approvals</h4>
                    <p class="text-3xl font-bold text-yellow-900">0</p>
                </div>
            </div>
            <div class="mt-8">
                <h4 class="text-xl font-semibold text-gray-700 mb-4">Recent Activities</h4>
                <ul class="list-disc list-inside text-gray-600" id="dashboard-activities">
                    <li>No recent activities.</li>
                </ul>
            </div>
        </section>

        <!-- Manage Employees Section -->
        <section id="manage-employees-content" class="section-content">
            <h3 class="text-2xl font-semibold text-gray-700 mb-4">Manage Employees</h3>
            <p class="text-gray-600 mb-6">Here you can add, edit, or remove employee records. View detailed profiles including personal information, employment history, and compensation.</p>
            <button id="add-employee-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200">Add New Employee</button>

            <div class="mt-8">
                <h4 class="text-xl font-semibold text-gray-700 mb-4">Employee List</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-gray-100 text-left text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Employee ID</th>
                                <th class="py-3 px-6 text-left">Name</th>
                                <th class="py-3 px-6 text-left">Department</th>
                                <th class="py-3 px-6 text-left">Position</th>
                                <th class="py-3 px-6 text-left">Status</th>
                                <th class="py-3 px-6 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-700 text-sm font-light" id="employees-table-body">
                            <tr>
                                <td colspan="6" class="py-4 text-center text-gray-500">Loading employee data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Department/Sites Section -->
        <section id="departments-sites-content" class="section-content">
            <h3 class="text-2xl font-semibold text-gray-700 mb-4">Department & Sites Management</h3>
            <p class="text-gray-600 mb-6">Manage company departments and project sites. Assign employees to specific departments or sites for accurate payroll allocation.</p>
            <button id="add-dept-site-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200">Add New Department/Site</button>

            <div class="mt-8">
                <h4 class="text-xl font-semibold text-gray-700 mb-4">Departments</h4>
                <ul class="list-disc list-inside text-gray-600 pl-4" id="departments-list">
                    <li>Loading departments...</li>
                </ul>
            </div>
            <div class="mt-8">
                <h4 class="text-xl font-semibold text-gray-700 mb-4">Project Sites</h4>
                <ul class="list-disc list-inside text-gray-600 pl-4" id="sites-list">
                    <li>Loading sites...</li>
                </ul>
            </div>
        </section>

        <!-- Payroll Section -->
        <section id="payroll-content" class="section-content">
            <h3 class="text-2xl font-semibold text-gray-700 mb-4">Payroll Processing</h3>
            <p class="text-gray-600 mb-6">Process payroll, generate payslips, manage deductions, and view payroll history.</p>
            <button class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200">Process Payroll for Current Period</button>

            <div class="mt-8 p-6 bg-gray-50 rounded-lg shadow-md text-gray-700">
                <p>No payroll history available. Process payroll to view records here.</p>
            </div>
        </section>
    </main>

    <!-- Admin Password Modal -->
    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" data-modal-id="admin-modal">&times;</span>
            <h3 class="text-xl font-semibold mb-4 text-center">Administrator Login</h3>
            <p class="text-gray-700 text-center">Please enter the administrator password:</p>
            <input type="password" id="admin-password-input" placeholder="Enter password" class="w-full px-4 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mt-4">
            <button id="admin-password-submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md mt-4 transition duration-200">Submit</button>
            <p id="admin-message" class="text-red-500 mt-2 hidden text-center">Incorrect password. Please try again.</p>
        </div>
    </div>

    <!-- Add New Employee Modal -->
    <div id="add-employee-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" data-modal-id="add-employee-modal">&times;</span>
            <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Add New Employee</h3>
            <form id="add-employee-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="form-group">
                        <label for="employee-id">Employee ID:</label>
                        <input type="text" id="employee-id" value="DLV-XXXXX" readonly class="bg-gray-100 cursor-not-allowed">
                    </div>
                    <div class="form-group">
                        <label for="employee-name">Full Name:</label>
                        <input type="text" id="employee-name" placeholder="e.g., Juan Dela Cruz" required>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="form-group">
                        <label for="employee-department">Department:</label>
                        <input type="text" id="employee-department" placeholder="e.g., Engineering" required>
                    </div>
                    <div class="form-group">
                        <label for="employee-position">Position:</label>
                        <input type="text" id="employee-position" placeholder="e.g., Electrical Engineer" required>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="form-group">
                        <label for="employee-status">Status:</label>
                        <select id="employee-status" required>
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="employee-site">Site:</label>
                        <input type="text" id="employee-site" placeholder="e.g., Main Office - QC" required>
                    </div>
                </div>

                <div class="form-group mb-6">
                    <label for="employee-salary">Monthly Salary (PHP):</label>
                    <input type="number" id="employee-salary" placeholder="e.g., 25000.00" step="0.01" required>
                </div>

                <h4 class="text-lg font-semibold text-gray-700 mb-3">Government Deductions</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="form-group">
                        <label for="deduction-sss">SSS Contribution:</label>
                        <input type="number" id="deduction-sss" placeholder="e.g., 800.00" step="0.01" value="0">
                    </div>
                    <div class="form-group">
                        <label for="deduction-philhealth">PH Contribution:</label>
                        <input type="number" id="deduction-philhealth" placeholder="e.g., 400.00" step="0.01" value="0">
                    </div>
                    <div class="form-group">
                        <label for="deduction-pagibig">Pag-IBIG Contribution:</label>
                        <input type="number" id="deduction-pagibig" placeholder="e.g., 200.00" step="0.01" value="0">
                    </div>
                </div>

                <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-200">Save Employee</button>
            </form>
        </div>
    </div>

    <!-- Add New Department/Site Modal -->
    <div id="add-dept-site-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" data-modal-id="add-dept-site-modal">&times;</span>
            <h3 class="text-xl font-semibold mb-4 text-center">Add New Department or Site</h3>
            <form id="add-dept-site-form">
                <label for="dept-site-name">Name:</label>
                <input type="text" id="dept-site-name" placeholder="Enter name" required>

                <label for="dept-site-type">Type:</label>
                <select id="dept-site-type" required>
                    <option value="Department">Department</option>
                    <option value="Site">Site</option>
                </select>

                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md mt-4 transition duration-200">Save</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const navButtons = document.querySelectorAll('.nav-button');
            const sections = document.querySelectorAll('.section-content');
            const adminLoginBtn = document.getElementById('admin-login-btn');
            const adminModal = document.getElementById('admin-modal');
            const adminCloseBtn = adminModal.querySelector('.modal-close');
            const adminPasswordInput = document.getElementById('admin-password-input');
            const adminPasswordSubmit = document.getElementById('admin-password-submit');
            const adminMessage = document.getElementById('admin-message');

            const addEmployeeBtn = document.getElementById('add-employee-btn');
            const addEmployeeModal = document.getElementById('add-employee-modal');
            const addEmployeeCloseBtn = addEmployeeModal.querySelector('.modal-close');
            const addEmployeeForm = document.getElementById('add-employee-form');
            const employeeIdInput = document.getElementById('employee-id');
            const employeesTableBody = document.getElementById('employees-table-body');
            const totalEmployeesCount = document.getElementById('total-employees-count');
            const dashboardActivities = document.getElementById('dashboard-activities');

            const addDeptSiteBtn = document.getElementById('add-dept-site-btn');
            const addDeptSiteModal = document.getElementById('add-dept-site-modal');
            const addDeptSiteCloseBtn = addDeptSiteModal.querySelector('.modal-close');
            const addDeptSiteForm = document.getElementById('add-dept-site-form');
            const departmentsList = document.getElementById('departments-list');
            const sitesList = document.getElementById('sites-list');

            let employeesData = [];
            let departmentsData = [];
            let sitesData = [];

            // Function to show a specific section
            const showSection = (sectionId) => {
                sections.forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(sectionId).classList.add('active');
            };

            // Function to open a modal
            const openModal = (modalElement) => {
                modalElement.style.display = 'flex';
            };

            // Function to close a modal
            const closeModal = (modalElement) => {
                modalElement.style.display = 'none';
            };

            // Generate Employee ID
            const generateEmployeeId = () => {
                const randomNumbers = Math.floor(10000 + Math.random() * 90000); // Generates a 5-digit number
                return `DLV-${randomNumbers}`;
            };

            // Render Employees Table
            const renderEmployees = () => {
                if (employeesData.length === 0) {
                    employeesTableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="py-4 text-center text-gray-500">No employee data available. Click "Add New Employee" to get started.</td>
                        </tr>
                    `;
                } else {
                    employeesTableBody.innerHTML = employeesData.map(employee => `
                        <tr class="border-b border-gray-200 hover:bg-gray-50">
                            <td class="py-3 px-6 text-left whitespace-nowrap">${employee.id}</td>
                            <td class="py-3 px-6 text-left">${employee.name}</td>
                            <td class="py-3 px-6 text-left">${employee.department}</td>
                            <td class="py-3 px-6 text-left">${employee.position}</td>
                            <td class="py-3 px-6 text-left"><span class="bg-${employee.status === 'Active' ? 'green' : 'red'}-200 text-${employee.status === 'Active' ? 'green' : 'red'}-800 py-1 px-3 rounded-full text-xs">${employee.status}</span></td>
                            <td class="py-3 px-6 text-left">
                                <button class="text-blue-500 hover:text-blue-700 mr-2" onclick="editEmployee('${employee.docId}')">Edit</button>
                                <button class="text-red-500 hover:text-red-700" onclick="deleteEmployee('${employee.docId}')">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                }
                totalEmployeesCount.textContent = employeesData.length;
            };

            // Render Departments List
            const renderDepartments = () => {
                if (departmentsData.length === 0) {
                    departmentsList.innerHTML = `<li>No departments added yet.</li>`;
                } else {
                    departmentsList.innerHTML = departmentsData.map(dept => `<li>${dept.name}</li>`).join('');
                }
            };

            // Render Sites List
            const renderSites = () => {
                if (sitesData.length === 0) {
                    sitesList.innerHTML = `<li>No sites added yet.</li>`;
                } else {
                    sitesList.innerHTML = sitesData.map(site => `<li>${site.name}</li>`).join('');
                }
            };

            // Handle navigation button clicks
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    const targetSectionId = button.dataset.section + '-content';
                    showSection(targetSectionId);
                });
            });

            // Show Dashboard by default
            showSection('dashboard-content');

            // Admin Login Modal functionality
            adminLoginBtn.addEventListener('click', () => {
                openModal(adminModal);
                adminPasswordInput.value = ''; // Clear previous input
                adminMessage.classList.add('hidden'); // Hide previous messages
            });

            adminCloseBtn.addEventListener('click', () => {
                closeModal(adminModal);
            });

            adminPasswordSubmit.addEventListener('click', () => {
                const password = adminPasswordInput.value;
                // Simple hardcoded password for demonstration.
                // In a real application, this would involve secure authentication.
                if (password === 'admin123') {
                    // Using a custom message box instead of alert()
                    const messageBox = document.createElement('div');
                    messageBox.className = 'fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-[1001]';
                    messageBox.innerHTML = `
                        <div class="bg-white p-8 rounded-lg shadow-xl text-center">
                            <p class="text-lg font-semibold mb-4">Administrator access granted!</p>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md" onclick="this.parentNode.parentNode.remove()">OK</button>
                        </div>
                    `;
                    document.body.appendChild(messageBox);

                    closeModal(adminModal);
                    adminMessage.classList.add('hidden');
                } else {
                    adminMessage.textContent = 'Incorrect password. Please try again.';
                    adminMessage.classList.remove('hidden');
                }
            });

            // Add New Employee Modal functionality
            addEmployeeBtn.addEventListener('click', () => {
                employeeIdInput.value = generateEmployeeId(); // Set new ID
                addEmployeeForm.reset(); // Clear form fields
                openModal(addEmployeeModal);
            });

            addEmployeeCloseBtn.addEventListener('click', () => {
                closeModal(addEmployeeModal);
            });

            addEmployeeForm.addEventListener('submit', async (event) => {
                event.preventDefault(); // Prevent default form submission

                if (!window.fb.isAuthReady || !window.fb.userId || !window.fb.appId) {
                    console.error("Firebase not ready or user/app ID not authenticated. isAuthReady:", window.fb.isAuthReady, "userId:", window.fb.userId, "appId:", window.fb.appId);
                    // Using a custom message box instead of alert()
                    const messageBox = document.createElement('div');
                    messageBox.className = 'fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-[1001]';
                    messageBox.innerHTML = `
                        <div class="bg-white p-8 rounded-lg shadow-xl text-center">
                            <p class="text-lg font-semibold mb-4 text-red-600">System not ready. Please try again in a moment.</p>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md" onclick="this.parentNode.parentNode.remove()">OK</button>
                        </div>
                    `;
                    document.body.appendChild(messageBox);
                    return;
                }

                const employeeData = {
                    id: document.getElementById('employee-id').value, // Use the generated ID from the input
                    name: document.getElementById('employee-name').value,
                    department: document.getElementById('employee-department').value,
                    position: document.getElementById('employee-position').value,
                    status: document.getElementById('employee-status').value,
                    site: document.getElementById('employee-site').value,
                    salary: parseFloat(document.getElementById('employee-salary').value),
                    sss: parseFloat(document.getElementById('deduction-sss').value),
                    philhealth: parseFloat(document.getElementById('deduction-philhealth').value), // Keep this name for data consistency
                    pagibig: parseFloat(document.getElementById('deduction-pagibig').value),
                    createdAt: new Date() // Timestamp for sorting or activity tracking
                };

                try {
                    const docRef = await window.fb.addDoc(window.fb.collection(window.fb.db, `artifacts/${window.fb.appId}/users/${window.fb.userId}/employees`), employeeData);
                    console.log("Employee added with ID: ", docRef.id);
                    dashboardActivities.innerHTML = `<li>New employee, ${employeeData.name}, added.</li>` + dashboardActivities.innerHTML;
                    closeModal(addEmployeeModal);

                    // Using a custom message box instead of alert()
                    const messageBox = document.createElement('div');
                    messageBox.className = 'fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-[1001]';
                    messageBox.innerHTML = `
                        <div class="bg-white p-8 rounded-lg shadow-xl text-center">
                            <p class="text-lg font-semibold mb-4 text-green-600">Employee saved successfully!</p>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md" onclick="this.parentNode.parentNode.remove()">OK</button>
                        </div>
                    `;
                    document.body.appendChild(messageBox);

                } catch (e) {
                    console.error("Error adding document: ", e);
                    // Using a custom message box instead of alert()
                    const messageBox = document.createElement('div');
                    messageBox.className = 'fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-[1001]';
                    messageBox.innerHTML = `
                        <div class="bg-white p-8 rounded-lg shadow-xl text-center">
                            <p class="text-lg font-semibold mb-4 text-red-600">Error saving employee. Please check console for details.</p>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md" onclick="this.parentNode.parentNode.remove()">OK</button>
                        </div>
                    `;
                    document.body.appendChild(messageBox);
                }
            });

            // Add New Department/Site Modal functionality
            addDeptSiteBtn.addEventListener('click', () => {
                addDeptSiteForm.reset(); // Clear form fields
                openModal(addDeptSiteModal);
            });

            addDeptSiteCloseBtn.addEventListener('click', () => {
                closeModal(addDeptSiteModal);
            });

            addDeptSiteForm.addEventListener('submit', async (event) => {
                event.preventDefault(); // Prevent default form submission

                if (!window.fb.isAuthReady || !window.fb.userId || !window.fb.appId) {
                    console.error("Firebase not ready or user/app ID not authenticated. isAuthReady:", window.fb.isAuthReady, "userId:", window.fb.userId, "appId:", window.fb.appId);
                    // Using a custom message box instead of alert()
                    const messageBox = document.createElement('div');
                    messageBox.className = 'fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-[1001]';
                    messageBox.innerHTML = `
                        <div class="bg-white p-8 rounded-lg shadow-xl text-center">
                            <p class="text-lg font-semibold mb-4 text-red-600">System not ready. Please try again in a moment.</p>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md" onclick="this.parentNode.parentNode.remove()">OK</button>
                        </div>
                    `;
                    document.body.appendChild(messageBox);
                    return;
                }

                const deptSiteData = {
                    name: document.getElementById('dept-site-name').value,
                    type: document.getElementById('dept-site-type').value,
                    createdAt: new Date()
                };

                try {
                    const collectionPath = `artifacts/${window.fb.appId}/users/${window.fb.userId}/${deptSiteData.type === 'Department' ? 'departments' : 'sites'}`;
                    const docRef = await window.fb.addDoc(window.fb.collection(window.fb.db, collectionPath), deptSiteData);
                    console.log(`${deptSiteData.type} added with ID: `, docRef.id);
                    dashboardActivities.innerHTML = `<li>New ${deptSiteData.type}, ${deptSiteData.name}, added.</li>` + dashboardActivities.innerHTML;
                    closeModal(addDeptSiteModal);

                    // Using a custom message box instead of alert()
                    const messageBox = document.createElement('div');
                    messageBox.className = 'fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-[1001]';
                    messageBox.innerHTML = `
                        <div class="bg-white p-8 rounded-lg shadow-xl text-center">
                            <p class="text-lg font-semibold mb-4 text-green-600">Department/Site saved successfully!</p>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md" onclick="this.parentNode.parentNode.remove()">OK</button>
                        </div>
                    `;
                    document.body.appendChild(messageBox);

                } catch (e) {
                    console.error("Error adding document: ", e);
                    // Using a custom message box instead of alert()
                    const messageBox = document.createElement('div');
                    messageBox.className = 'fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-[1001]';
                    messageBox.innerHTML = `
                        <div class="bg-white p-8 rounded-lg shadow-xl text-center">
                            <p class="text-lg font-semibold mb-4 text-red-600">Error saving department/site. Please check console for details.</p>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md" onclick="this.parentNode.parentNode.remove()">OK</button>
                        </div>
                    `;
                    document.body.appendChild(messageBox);
                }
            });

            // Global functions for Firestore operations (called from rendered HTML)
            window.editEmployee = (docId) => {
                console.log('Edit employee:', docId);
                // Using a custom message box instead of alert()
                const messageBox = document.createElement('div');
                messageBox.className = 'fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-[1001]';
                messageBox.innerHTML = `
                    <div class="bg-white p-8 rounded-lg shadow-xl text-center">
                        <p class="text-lg font-semibold mb-4">Edit functionality not yet implemented for employee ID: ${docId}</p>
                        <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md" onclick="this.parentNode.parentNode.remove()">OK</button>
                    </div>
                `;
                document.body.appendChild(messageBox);
                // Future: Populate add-employee-modal with existing data and change save button to update
            };

            window.deleteEmployee = async (docId) => {
                // Using a custom confirmation box instead of confirm()
                const confirmBox = document.createElement('div');
                confirmBox.className = 'fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-[1001]';
                confirmBox.innerHTML = `
                    <div class="bg-white p-8 rounded-lg shadow-xl text-center">
                        <p class="text-lg font-semibold mb-4">Are you sure you want to delete this employee?</p>
                        <button class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md mr-2" id="confirm-delete-yes">Yes</button>
                        <button class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md" id="confirm-delete-no">No</button>
                    </div>
                `;
                document.body.appendChild(confirmBox);

                document.getElementById('confirm-delete-yes').onclick = async () => {
                    confirmBox.remove(); // Close confirmation box

                    if (!window.fb.isAuthReady || !window.fb.userId || !window.fb.appId) {
                        console.error("Firebase not ready or user/app ID not authenticated. isAuthReady:", window.fb.isAuthReady, "userId:", window.fb.userId, "appId:", window.fb.appId);
                        // Using a custom message box instead of alert()
                        const messageBox = document.createElement('div');
                        messageBox.className = 'fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-[1001]';
                        messageBox.innerHTML = `
                            <div class="bg-white p-8 rounded-lg shadow-xl text-center">
                                <p class="text-lg font-semibold mb-4 text-red-600">System not ready. Please try again in a moment.</p>
                                <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md" onclick="this.parentNode.parentNode.remove()">OK</button>
                            </div>
                        `;
                        document.body.appendChild(messageBox);
                        return;
                    }
                    try {
                        await window.fb.deleteDoc(window.fb.doc(window.fb.db, `artifacts/${window.fb.appId}/users/${window.fb.userId}/employees`, docId));
                        console.log("Employee deleted:", docId);
                        dashboardActivities.innerHTML = `<li>Employee with ID ${docId} deleted.</li>` + dashboardActivities.innerHTML;

                        // Using a custom message box instead of alert()
                        const messageBox = document.createElement('div');
                        messageBox.className = 'fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-[1001]';
                        messageBox.innerHTML = `
                            <div class="bg-white p-8 rounded-lg shadow-xl text-center">
                                <p class="text-lg font-semibold mb-4 text-green-600">Employee deleted successfully!</p>
                                <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md" onclick="this.parentNode.parentNode.remove()">OK</button>
                            </div>
                        `;
                        document.body.appendChild(messageBox);

                    } catch (e) {
                        console.error("Error deleting document: ", e);
                        // Using a custom message box instead of alert()
                        const messageBox = document.createElement('div');
                        messageBox.className = 'fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-[1001]';
                        messageBox.innerHTML = `
                            <div class="bg-white p-8 rounded-lg shadow-xl text-center">
                                <p class="text-lg font-semibold mb-4 text-red-600">Error deleting employee. Please check console for details.</p>
                                <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md" onclick="this.parentNode.parentNode.remove()">OK</button>
                            </div>
                        `;
                        document.body.appendChild(messageBox);
                    }
                };

                document.getElementById('confirm-delete-no').onclick = () => {
                    confirmBox.remove(); // Close confirmation box
                };
            };

            // Close modals when clicking outside
            window.addEventListener('click', (event) => {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (event.target == modal) {
                        closeModal(modal);
                    }
                });
            });

            // Listen for FirebaseReady event to start data listeners
            document.addEventListener('firebaseReady', () => {
                const appId = window.fb.appId;
                const userId = window.fb.userId;

                console.log("FirebaseReady event fired. AppId:", appId, "UserId:", userId);

                if (userId && appId) {
                    // Listen for employees data
                    window.fb.onSnapshot(window.fb.collection(window.fb.db, `artifacts/${appId}/users/${userId}/employees`), (snapshot) => {
                        employeesData = snapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));
                        renderEmployees();
                        console.log("Employees data updated from Firestore:", employeesData);
                    }, (error) => {
                        console.error("Error fetching employees:", error);
                        employeesTableBody.innerHTML = `<tr><td colspan="6" class="py-4 text-center text-red-500">Error loading employees. Check console for permissions.</td></tr>`;
                    });

                    // Listen for departments data
                    window.fb.onSnapshot(window.fb.collection(window.fb.db, `artifacts/${appId}/users/${userId}/departments`), (snapshot) => {
                        departmentsData = snapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));
                        renderDepartments();
                        console.log("Departments data updated from Firestore:", departmentsData);
                    }, (error) => {
                        console.error("Error fetching departments:", error);
                        departmentsList.innerHTML = `<li>Error loading departments. Check console for permissions.</li>`;
                    });

                    // Listen for sites data
                    window.fb.onSnapshot(window.fb.collection(window.fb.db, `artifacts/${appId}/users/${userId}/sites`), (snapshot) => {
                        sitesData = snapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));
                        renderSites();
                        console.log("Sites data updated from Firestore:", sitesData);
                    }, (error) => {
                        console.error("Error fetching sites:", error);
                        sitesList.innerHTML = `<li>Error loading sites. Check console for permissions.</li>`;
                    });
                } else {
                    console.warn("Firebase not fully initialized during firebaseReady event. User ID or App ID is missing. Cannot fetch Firestore data.");
                    employeesTableBody.innerHTML = `<tr><td colspan="6" class="py-4 text-center text-gray-500">Firebase not ready. Please ensure authentication is set up.</td></tr>`;
                    departmentsList.innerHTML = `<li>Firebase not ready.</li>`;
                    sitesList.innerHTML = `<li>Firebase not ready.</li>`;
                }
            });
        });
    </script>
</body>
</html>
